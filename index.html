<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>batas ¬∑ manusia ‚Äî generator ide video petualangan</title>
    <!-- Plus Jakarta Sans untuk logo dan judul -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Inter untuk lainnya -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300..700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", sans-serif;
            background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 1.8rem;
            color: #333333;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .logo-container {
            text-align: center;
            margin: 0.5rem 0 2.5rem 0;
        }
        .logo-container h1 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 2.8rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #a855f7, #d946ef);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            text-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
        }
        .logo-container .sub {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 400;
            color: #666666;
            font-size: 1rem;
            margin-top: 0.25rem;
            letter-spacing: 0.3px;
            text-shadow: 0 0 10px rgba(168, 85, 247, 0.2);
        }

        .card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border-radius: 2.5rem;
            padding: 2.2rem 2.2rem;
            box-shadow: 0 25px 50px -12px rgba(168, 85, 247, 0.2), 0 4px 18px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(168, 85, 247, 0.2);
            transition: all 0.2s ease;
        }

        .api-key-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 1rem 1.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.8rem;
            border: 1px solid rgba(168, 85, 247, 0.3);
            box-shadow: 0 10px 15px -3px rgba(168, 85, 247, 0.1);
        }
        .api-key-label {
            font-weight: 600;
            color: #a855f7;
            min-width: 90px;
            font-size: 0.95rem;
        }
        .api-key-input {
            flex: 1;
            min-width: 220px;
            padding: 0.7rem 1.3rem;
            border-radius: 3rem;
            border: 2px solid #e5e7eb;
            font-family: 'Inter', monospace;
            font-size: 0.9rem;
            background: white;
            color: #333333;
            outline: none;
            transition: 0.15s;
        }
        .api-key-input:focus {
            border-color: #a855f7;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
        }
        .api-key-hint {
            font-size: 0.8rem;
            color: #666666;
            width: 100%;
            margin-top: 0.2rem;
        }

        .version-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 1rem 1.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.8rem;
            border: 1px solid rgba(168, 85, 247, 0.3);
            box-shadow: 0 10px 15px -3px rgba(168, 85, 247, 0.1);
        }
        .version-label {
            font-weight: 600;
            color: #a855f7;
            min-width: 90px;
            font-size: 0.95rem;
        }
        .version-select {
            flex: 1;
            min-width: 220px;
            padding: 0.7rem 1.3rem;
            border-radius: 3rem;
            border: 2px solid #e5e7eb;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            background: white;
            color: #333333;
            outline: none;
            transition: 0.15s;
            cursor: pointer;
        }
        .version-select:focus {
            border-color: #a855f7;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
        }
        .version-description {
            font-size: 0.8rem;
            color: #666666;
            width: 100%;
            margin-top: 0.2rem;
            font-style: italic;
        }

        .button-generate {
            background: linear-gradient(135deg, #a855f7, #d946ef);
            border: none;
            padding: 0.8rem 2.2rem;
            border-radius: 3rem;
            font-weight: 600;
            font-size: 1rem;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            cursor: pointer;
            box-shadow: 0 10px 25px -5px rgba(168, 85, 247, 0.3);
            transition: 0.2s;
            letter-spacing: 0.01em;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .button-generate:hover {
            background: linear-gradient(135deg, #9333ea, #c026d3);
            box-shadow: 0 15px 30px -5px rgba(168, 85, 247, 0.4);
            transform: scale(1.02);
        }

        .button-generate:disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(0.3);
        }

        .button-secondary {
            background: white;
            border: 1.5px solid #a855f7;
            padding: 0.5rem 1.5rem;
            border-radius: 3rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: #a855f7;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.1);
            transition: 0.1s;
        }
        .button-secondary:hover {
            background: #a855f7;
            color: white;
            border-color: #d946ef;
        }

        .idea-grid {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin: 1.5rem 0 1.5rem;
        }

        .idea-item {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 0.9rem 1.5rem;
            border-left: 8px solid #a855f7;
            box-shadow: 0 10px 15px -3px rgba(168, 85, 247, 0.1);
            transition: 0.15s ease;
            cursor: pointer;
            border: 1px solid rgba(168, 85, 247, 0.2);
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .idea-item:hover {
            background: white;
            border-left-width: 12px;
            border-left-color: #d946ef;
            box-shadow: 0 15px 20px -5px rgba(168, 85, 247, 0.2);
        }

        .idea-item.selected {
            background: white;
            border-left-color: #d946ef;
            border: 2px solid #a855f7;
            box-shadow: 0 8px 25px rgba(168, 85, 247, 0.2);
        }

        .idea-number {
            width: 2.3rem;
            height: 2.3rem;
            background: linear-gradient(135deg, #a855f7, #d946ef);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            font-size: 0.9rem;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.3);
        }

        .idea-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333333;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .script-output {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(16px);
            border-radius: 2.5rem;
            padding: 1.8rem;
            border: 1px solid rgba(168, 85, 247, 0.2);
            box-shadow: 0 20px 40px -15px rgba(168, 85, 247, 0.15);
            margin-top: 2rem;
        }

        .script-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #a855f7;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .script-text {
            font-size: 1.1rem;
            line-height: 1.6;
            white-space: pre-wrap;
            color: #333333;
            font-weight: 400;
            border-left: 4px solid #a855f7;
            padding-left: 1.3rem;
        }

        .scene-prompt {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 1.3rem;
            margin: 1.5rem 0 0.5rem;
            border: 1px dashed #a855f7;
        }

        .scene-title {
            font-weight: 700;
            color: #a855f7;
            margin-bottom: 0.8rem;
            font-size: 1.2rem;
        }

        .prompt-container {
            background: white;
            border-radius: 1.3rem;
            padding: 0.9rem 1.2rem;
            margin-bottom: 0.8rem;
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .badge {
            background: linear-gradient(135deg, #a855f7, #d946ef);
            border-radius: 3rem;
            padding: 0.2rem 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            display: inline-block;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.2);
        }

        .copy-btn {
            background: none;
            border: 1px solid #a855f7;
            color: #a855f7;
            padding: 0.2rem 1rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.1s;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .copy-btn:hover {
            background: #a855f7;
            color: white;
        }

        .copy-btn.copied {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .prompt-text {
            font-size: 0.9rem;
            color: #333333;
            line-height: 1.5;
            word-break: break-word;
        }

        .prompt-full {
            display: none;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #a855f7;
        }

        .show-more {
            color: #a855f7;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 0.25rem;
            display: inline-block;
        }

        hr {
            border: 0.5px solid rgba(168, 85, 247, 0.2);
            margin: 1.2rem 0;
        }

        .action-bottom {
            display: flex;
            justify-content: center;
            margin: 1rem 0 0.2rem;
        }

        .selected-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            border-radius: 4rem;
            padding: 0.5rem 1.5rem;
            margin: 1rem 0 0.5rem;
            border: 1px solid #a855f7;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.1);
        }

        #selectedDisplay {
            color: #a855f7;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .footer-credit {
            text-align: center;
            color: #a855f7;
            margin-top: 2rem;
            font-size: 0.8rem;
        }

        .error-message {
            background: #fee2e2;
            color: #b91c1c;
            padding: 0.8rem 1.5rem;
            border-radius: 3rem;
            margin: 1rem 0;
            border: 1px solid #ef4444;
            font-weight: 500;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .raw-response {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: monospace;
            font-size: 0.8rem;
            padding: 1rem;
            border-radius: 1rem;
            margin-top: 1rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow: auto;
        }

        .get-key-link {
            color: #a855f7;
            font-weight: 600;
            text-decoration: none;
            border-bottom: 1px dashed #a855f7;
        }
        .get-key-link:hover {
            color: #d946ef;
        }

        .audio-player-container {
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 2rem;
            border: 1px solid rgba(168, 85, 247, 0.3);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .audio-player-container audio {
            width: 100%;
            height: 40px;
            border-radius: 2rem;
        }

        .audio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #a855f7;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .voice-badge {
            background: rgba(168, 85, 247, 0.15);
            border: 1px solid #a855f7;
            color: #a855f7;
            padding: 0.2rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            margin-left: 0.5rem;
        }

        .loading-audio {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #a855f7;
            font-size: 0.9rem;
            padding: 0.5rem;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(168, 85, 247, 0.3);
            border-top-color: #a855f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, #a855f7, #d946ef);
            color: white;
            padding: 0.2rem 1rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .petualangan-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 1rem 1.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.8rem;
            border: 1px solid rgba(168, 85, 247, 0.3);
            box-shadow: 0 10px 15px -3px rgba(168, 85, 247, 0.1);
        }
        .petualangan-label {
            font-weight: 600;
            color: #a855f7;
            min-width: 120px;
            font-size: 0.95rem;
        }
        .petualangan-select {
            flex: 1;
            min-width: 220px;
            padding: 0.7rem 1.3rem;
            border-radius: 3rem;
            border: 2px solid #e5e7eb;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            background: white;
            color: #333333;
            outline: none;
            transition: 0.15s;
            cursor: pointer;
        }
        .petualangan-select:focus {
            border-color: #a855f7;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
        }
        .petualangan-description {
            font-size: 0.8rem;
            color: #666666;
            width: 100%;
            margin-top: 0.2rem;
            font-style: italic;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="logo-container">
        <h1>batas ¬∑ manusia</h1>
        <div class="sub">kegagalan biologis dalam petualangan epik</div>
    </div>

    <div class="card">
        <div class="api-key-container">
            <span class="api-key-label">üîë Groq Key</span>
            <input type="password" id="apiKeyInput" class="api-key-input" placeholder="gsk_...">
            <div class="api-key-hint">
                <a href="https://console.groq.com/keys" target="_blank" class="get-key-link">Dapatkan key</a>
            </div>
        </div>

        <div class="api-key-container">
            <span class="api-key-label">üé§ ElevenLabs Key</span>
            <input type="password" id="elevenLabsKeyInput" class="api-key-input" placeholder="elevenlabs_...">
            <div class="api-key-hint">
                <a href="https://elevenlabs.io/app/settings/api-keys" target="_blank" class="get-key-link">Dapatkan key</a> (opsional)
                <span class="voice-badge">‚ú® Rachel</span>
            </div>
        </div>

        <!-- VERSION SELECTOR -->
        <div class="version-container">
            <span class="version-label">üé≠ Versi Ide</span>
            <select id="versionSelect" class="version-select">
                <option value="1">üåø Versi 1: Relatable (realistis)</option>
                <option value="2">üî• Versi 2: Ekstrem (dramatis)</option>
                <option value="3">üåÄ Versi 3: Surreal (absurd)</option>
                <option value="4">üé≠ Versi 4: Filosofis absurd</option>
                <option value="5">üé™ Versi 5: Random murni</option>
                <option value="6">üß™ Versi 6: Aktivitas aneh</option>
                <option value="7">üìä Versi 7: Ilmiah palsu</option>
                <option value="8">üé† Versi 8: Keseharian absurd</option>
                <option value="9">ü™Ñ Versi 9: Fantasi</option>
                <option value="10">üåå Versi 10: Digital</option>
                <option value="11" selected>üè¥‚Äç‚ò†Ô∏è Versi 11: PETUALANGAN (bajak laut, ksatria, dll)</option>
            </select>
            <div class="version-description" id="versionDescription">
                üè¥‚Äç‚ò†Ô∏è PETUALANGAN EPIK - bajak laut, ksatria, penjelajah, luar angkasa, dll
            </div>
        </div>

        <!-- PETUALANGAN THEME SELECTOR (hanya muncul jika versi 11 dipilih) -->
        <div id="petualanganContainer" class="petualangan-container">
            <span class="petualangan-label">üè¥‚Äç‚ò†Ô∏è Tema Petualangan</span>
            <select id="petualanganSelect" class="petualangan-select">
                <option value="bajaklaut">üè¥‚Äç‚ò†Ô∏è Bajak Laut - harta karun, kapal, lautan</option>
                <option value="ksatria">‚öîÔ∏è Ksatria - kastil, naga, pedang</option>
                <option value="penjelajah">üå≤ Penjelajah - hutan belantara, gunung, sungai</option>
                <option value="astronot">üöÄ Astronot - luar angkasa, planet asing</option>
                <option value="atlantis">üåä Atlantis - kota bawah laut, mitologi</option>
                <option value="mesir">üî∫ Mesir Kuno - piramida, mumi, firaun</option>
                <option value="viking">üõ∂ Viking - kapal panjang, mitologi nordik</option>
                <option value="samurai">üó°Ô∏è Samurai - Jepang kuno, bushido</option>
                <option value="cowboy">ü§† Koboi - barat liar, petualangan padang pasir</option>
                <option value="dunia lain">üåÄ Isekai - masuk ke dunia game/fantasi</option>
            </select>
            <div class="petualangan-description">
                Pilih tema petualangan untuk karakter skeleton
            </div>
        </div>

        <div id="ideaList" class="idea-grid">
            <div style="text-align: center; color: #666666; padding: 1.5rem; font-style: italic; font-size: 0.95rem;">
                Masukkan API Key, pilih versi, lalu generate
            </div>
        </div>

        <div id="selectedArea" style="display: none;">
            <div class="selected-bar">
                <span id="selectedDisplay">‚úî ide terpilih: </span>
                <button id="generateScriptBtn" class="button-secondary">üé¨ buat naskah petualangan</button>
            </div>
        </div>

        <div class="action-bottom">
            <button id="generateIdeasBtn" class="button-generate">
                <span>‚ú®</span> generate 5 ide fresh
            </button>
        </div>
    </div>

    <div id="scriptContainer" class="script-output" style="display: none;">
        <div class="script-label">naskah petualangan (bahasa indonesia) ¬∑ 50-70 detik ¬∑ 2-3 kalimat per scene</div>
        <div id="scriptText" class="script-text"></div>
        
        <div id="audioContainer" style="display: none;" class="audio-player-container">
            <div class="audio-label">
                <span>üéµ Suara Rachel</span>
            </div>
            <audio id="audioPlayer" controls preload="metadata">
                <source src="" type="audio/mpeg">
                Browser tidak mendukung audio player.
            </audio>
            <div id="audioLoading" class="loading-audio" style="display: none;">
                <div class="spinner"></div>
                <span>Menghasilkan suara...</span>
            </div>
        </div>

        <hr>
        <div class="script-label">image prompts (english ‚Äî format rumus)</div>
        <div id="scenePrompts"></div>
        <div id="debugResponse" style="display: none;" class="raw-response"></div>
    </div>

    <div class="footer-credit">
        [Subjek] + [Aksi Dinamis] + [Lingkungan Petualangan] + [Cahaya Epik] + [Sudut Kamera Aksi] + [VFX] + Render 3D
    </div>
</div>

<script>
    const GROQ_URL = "https://api.groq.com/openai/v1/chat/completions";
    const GROQ_MODEL = "llama-3.3-70b-versatile";
    const ELEVENLABS_URL = "https://api.elevenlabs.io/v1";
    const RACHEL_VOICE_ID = "21m00Tcm4TlvDq8ikWAM";
    
    const STORAGE_KEYS = {
        GROQ_API_KEY: 'batasManusia_groqKey',
        ELEVENLABS_API_KEY: 'batasManusia_elevenLabsKey'
    };
    
    let generatedIdeas = [];
    let selectedIdeaIndex = null;

    const generateIdeasBtn = document.getElementById('generateIdeasBtn');
    const ideaListDiv = document.getElementById('ideaList');
    const selectedArea = document.getElementById('selectedArea');
    const selectedDisplay = document.getElementById('selectedDisplay');
    const generateScriptBtn = document.getElementById('generateScriptBtn');
    const scriptContainer = document.getElementById('scriptContainer');
    const scriptTextDiv = document.getElementById('scriptText');
    const scenePromptsDiv = document.getElementById('scenePrompts');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const elevenLabsKeyInput = document.getElementById('elevenLabsKeyInput');
    const debugResponse = document.getElementById('debugResponse');
    const versionSelect = document.getElementById('versionSelect');
    const versionDescription = document.getElementById('versionDescription');
    const petualanganContainer = document.getElementById('petualanganContainer');
    const petualanganSelect = document.getElementById('petualanganSelect');
    
    const audioContainer = document.getElementById('audioContainer');
    const audioPlayer = document.getElementById('audioPlayer');
    const audioLoading = document.getElementById('audioLoading');

    // Show/hide petualangan selector based on version
    versionSelect.addEventListener('change', function() {
        const descriptions = {
            '1': 'üåø Aktivitas sehari-hari yang realistis (begadang, main game, kopi)',
            '2': 'üî• Versi paling dramatis dan ekstrem (meledak, hancur, menjerit)',
            '3': 'üåÄ Aktivitas surreal dan tidak masuk akal (menatap kulkas kosong, ngomong sama tembok)',
            '4': 'üé≠ Filosofis absurd (mencari arti hidup, overthinking, nahan uang)',
            '5': 'üé™ Kombinasi paling random dan tidak terduga',
            '6': 'üß™ Aktivitas aneh yang jarang terpikirkan (ngupas bawang, main petak umpet)',
            '7': 'üìä Gaya ilmiah palsu dengan satuan absurd (milidetik, desibel, volt)',
            '8': 'üé† Aktivitas keseharian yang dibikin absurd (nyari remote, bilang "bentar")',
            '9': 'ü™Ñ Dunia fantasi dan imajinasi (terbang di mimpi, ramuan cinta)',
            '10': 'üåå Tema digital dan teknologi (loading screen, update status, QR code)',
            '11': 'üè¥‚Äç‚ò†Ô∏è PETUALANGAN EPIK - bajak laut, ksatria, penjelajah, luar angkasa, dll'
        };
        versionDescription.textContent = descriptions[versionSelect.value];
        
        // Show petualangan selector only for version 11
        if (versionSelect.value === '11') {
            petualanganContainer.style.display = 'flex';
        } else {
            petualanganContainer.style.display = 'none';
        }
    });

    function loadSavedKeys() {
        const savedGroqKey = localStorage.getItem(STORAGE_KEYS.GROQ_API_KEY);
        if (savedGroqKey) apiKeyInput.value = savedGroqKey;
        
        const savedElevenLabsKey = localStorage.getItem(STORAGE_KEYS.ELEVENLABS_API_KEY);
        if (savedElevenLabsKey) elevenLabsKeyInput.value = savedElevenLabsKey;
    }

    function saveApiKey(key, value) {
        if (value) localStorage.setItem(key, value);
        else localStorage.removeItem(key);
    }

    function getApiKey() { return apiKeyInput.value.trim(); }
    function getElevenLabsKey() { return elevenLabsKeyInput.value.trim(); }
    function isValidApiKey(key) { return key.startsWith('gsk_') && key.length > 20; }

    apiKeyInput.addEventListener('input', () => saveApiKey(STORAGE_KEYS.GROQ_API_KEY, getApiKey()));
    elevenLabsKeyInput.addEventListener('input', () => saveApiKey(STORAGE_KEYS.ELEVENLABS_API_KEY, getElevenLabsKey()));

    async function generateAudioFile(text) {
        const apiKey = getElevenLabsKey();
        if (!apiKey) { 
            audioContainer.style.display = 'none'; 
            return null; 
        }

        try {
            audioLoading.style.display = 'flex';
            audioContainer.style.display = 'block';
            audioPlayer.src = '';
            
            const response = await fetch(`${ELEVENLABS_URL}/text-to-speech/${RACHEL_VOICE_ID}`, {
                method: 'POST',
                headers: {
                    'xi-api-key': apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: text,
                    model_id: 'eleven_multilingual_v2',
                    voice_settings: { stability: 0.75, similarity_boost: 0.75, style: 0.0, speed: 1.0, use_speaker_boost: true }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail?.message || `ElevenLabs API error: ${response.status}`);
            }

            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            audioPlayer.src = audioUrl;
            audioPlayer.load();
            audioLoading.style.display = 'none';
            return audioUrl;
            
        } catch (error) {
            console.error('TTS error:', error);
            audioLoading.style.display = 'none';
            audioContainer.style.display = 'none';
            throw new Error(`Gagal generate suara: ${error.message}`);
        }
    }

    generateIdeasBtn.addEventListener('click', async () => {
        const apiKey = getApiKey();
        
        if (!apiKey) {
            ideaListDiv.innerHTML = `<div class="error-message">‚ùå Masukkan API Key</div>`;
            return;
        }
        
        if (!isValidApiKey(apiKey)) {
            ideaListDiv.innerHTML = `<div class="error-message">‚ùå Format key harus "gsk_" + minimal 20 karakter</div>`;
            return;
        }

        generateIdeasBtn.disabled = true;
        generateIdeasBtn.innerHTML = '‚è≥ memproses...';
        ideaListDiv.innerHTML = `<div style="padding: 1.5rem; color:#666666; text-align:center;">‚è≥ mencari 5 ide fresh versi ${versionSelect.value}...</div>`;

        try {
            const ideas = await callGroqForIdeas(apiKey, versionSelect.value);
            
            if (!ideas || ideas.length === 0) {
                throw new Error('Tidak ada ide yang dihasilkan dari API');
            }
            
            generatedIdeas = ideas;
            renderIdeaList(ideas);
            selectedArea.style.display = 'none';
            scriptContainer.style.display = 'none';
            selectedIdeaIndex = null;
            
        } catch (e) {
            console.error('Error details:', e);
            
            let errorMessage = e.message;
            if (e.message.includes('401')) {
                errorMessage = 'API Key tidak valid atau telah expired. Dapatkan key baru di https://console.groq.com/keys';
            } else if (e.message.includes('429')) {
                errorMessage = 'Terlalu banyak request. Tunggu beberapa saat lalu coba lagi.';
            } else if (e.message.includes('500')) {
                errorMessage = 'Server Groq error. Coba lagi nanti.';
            }
            
            ideaListDiv.innerHTML = `<div class="error-message">‚ùå ${errorMessage}</div>`;
            
            // Tampilkan raw response jika ada
            if (e.rawResponse) {
                debugResponse.textContent = 'Raw Response:\n' + e.rawResponse;
                debugResponse.style.display = 'block';
            }
        } finally {
            generateIdeasBtn.disabled = false;
            generateIdeasBtn.innerHTML = '‚ú® generate 5 ide fresh';
        }
    });

    function selectIdea(index) {
        selectedIdeaIndex = index;
        const items = document.querySelectorAll('.idea-item');
        items.forEach((item, i) => {
            if (i === index) item.classList.add('selected');
            else item.classList.remove('selected');
        });
        selectedDisplay.innerText = `‚úî ide terpilih: ${generatedIdeas[index]}`;
        selectedArea.style.display = 'block';
        scriptContainer.style.display = 'none';
    }

    function renderIdeaList(ideas) {
        if (!ideas || ideas.length === 0) {
            ideaListDiv.innerHTML = `<div class="error-message">Tidak ada ide yang tersedia</div>`;
            return;
        }
        let html = '';
        ideas.forEach((idea, idx) => {
            html += `
                <div class="idea-item" data-index="${idx}">
                    <div class="idea-number">${idx+1}</div>
                    <div class="idea-content">
                        <div class="idea-title">${idea}</div>
                    </div>
                </div>
            `;
        });
        ideaListDiv.innerHTML = html;
        document.querySelectorAll('.idea-item').forEach((el) => {
            el.addEventListener('click', (e) => {
                const index = parseInt(el.dataset.index, 10);
                selectIdea(index);
            });
        });
    }

    async function copyText(button, text) {
        try {
            await navigator.clipboard.writeText(text);
            button.classList.add('copied');
            button.innerHTML = '‚úì copied';
            setTimeout(() => {
                button.classList.remove('copied');
                button.innerHTML = 'üìã copy';
            }, 2000);
        } catch (err) {
            alert('Gagal menyalin teks');
        }
    }

    function toggleFullPrompt(showMoreEl) {
        const fullDiv = showMoreEl.parentElement.querySelector('.prompt-full');
        if (fullDiv.style.display === 'none' || !fullDiv.style.display) {
            fullDiv.style.display = 'block';
            showMoreEl.textContent = 'sembunyikan';
        } else {
            fullDiv.style.display = 'none';
            showMoreEl.textContent = 'lihat selengkapnya';
        }
    }

    function detectFramingType(text) {
        const t = text.toLowerCase();
        
        if (t.includes("close-up") || t.includes("closeup")) return "closeup";
        if (t.includes("medium shot")) return "medium";
        if (t.includes("wide shot")) return "wide";
        if (t.includes("aerial") || t.includes("bird")) return "aerial";
        if (t.includes("low-angle")) return "low-angle";
        if (t.includes("high-angle")) return "high-angle";
        return "dynamic";
    }

    generateScriptBtn.addEventListener('click', async () => {
        if (selectedIdeaIndex === null || !generatedIdeas[selectedIdeaIndex]) {
            alert('Pilih ide terlebih dahulu');
            return;
        }

        const apiKey = getApiKey();
        if (!apiKey || !isValidApiKey(apiKey)) {
            alert('API Key tidak valid');
            return;
        }

        const selectedIdea = generatedIdeas[selectedIdeaIndex];
        const petualanganTheme = petualanganSelect ? petualanganSelect.value : 'bajaklaut';
        
        generateScriptBtn.disabled = true;
        generateScriptBtn.innerHTML = '‚è≥ menyusun naskah petualangan...';
        scriptContainer.style.display = 'block';
        scriptTextDiv.innerText = 'Menunggu response dari Groq...';
        scenePromptsDiv.innerHTML = '';
        debugResponse.style.display = 'none';
        audioContainer.style.display = 'none';

        try {
            const result = await callGroqForScript(apiKey, selectedIdea, versionSelect.value, petualanganTheme);
            
            if (!result.script || !result.scenes || result.scenes.length === 0) {
                throw new Error('Response tidak mengandung script atau scene yang valid');
            }
            
            scriptTextDiv.innerText = result.script;

            // Generate audio jika ada key ElevenLabs
            if (getElevenLabsKey()) {
                try {
                    await generateAudioFile(result.script);
                } catch (audioError) {
                    console.warn('Audio generation failed:', audioError);
                    // Tetap lanjutkan tanpa audio
                }
            }

            let scenesHtml = '';
            result.scenes.forEach((scene, idx) => {
                const framingType = detectFramingType(scene.imagePrompt);
                
                scenesHtml += `
                    <div class="scene-prompt">
                        <div class="scene-title">‚è±Ô∏è ${scene.time || `Scene ${idx+1}`} ¬∑ ${framingType}</div>
                        
                        <div class="prompt-container">
                            <div class="prompt-header">
                                <span class="badge">üñºÔ∏è IMAGE PROMPT</span>
                                <button class="copy-btn" onclick="copyText(this, \`${scene.imagePrompt.replace(/`/g, '\\`')}\`)">üìã copy</button>
                            </div>
                            <div class="prompt-text">${scene.imagePrompt.substring(0, 200)}...</div>
                            <div class="prompt-full">${scene.imagePrompt}</div>
                            <span class="show-more" onclick="toggleFullPrompt(this)">lihat selengkapnya</span>
                        </div>

                        <div class="prompt-container">
                            <div class="prompt-header">
                                <span class="badge">üé• VIDEO PROMPT</span>
                                <button class="copy-btn" onclick="copyText(this, \`${scene.videoPrompt.replace(/`/g, '\\`')}\`)">üìã copy</button>
                            </div>
                            <div class="prompt-text">${scene.videoPrompt.substring(0, 150)}...</div>
                            <div class="prompt-full">${scene.videoPrompt}</div>
                            <span class="show-more" onclick="toggleFullPrompt(this)">lihat selengkapnya</span>
                        </div>
                    </div>
                `;
            });
            scenePromptsDiv.innerHTML = scenesHtml;
            
        } catch (e) {
            console.error('Error:', e);
            
            let errorMessage = e.message;
            if (e.message.includes('401')) {
                errorMessage = 'API Key tidak valid atau telah expired. Dapatkan key baru di https://console.groq.com/keys';
            } else if (e.message.includes('429')) {
                errorMessage = 'Terlalu banyak request. Tunggu beberapa saat lalu coba lagi.';
            } else if (e.message.includes('500')) {
                errorMessage = 'Server Groq error. Coba lagi nanti.';
            }
            
            scriptTextDiv.innerText = '‚ùå GAGAL: ' + errorMessage;
            
            // Tampilkan debug response jika ada
            if (e.rawResponse) {
                debugResponse.textContent = 'Raw Response:\n' + e.rawResponse;
                debugResponse.style.display = 'block';
            }
        } finally {
            generateScriptBtn.disabled = false;
            generateScriptBtn.innerHTML = 'üé¨ buat naskah petualangan';
        }
    });

    loadSavedKeys();

    async function callGroqForIdeas(apiKey, version) {
        let basePrompt = `Buat 5 judul video pendek tentang batas tubuh manusia dalam PETUALANGAN EPIK.

Gunakan 3 FORMAT BERIKUT SECARA BERGANTIAN:
1. "Berapa [SATUAN WAKTU] [AKTIVITAS] Sampai [ORGAN/BAGIAN TUBUH] [KATA KERJA EKSTREM]?"
2. "Berapa Lama Kamu Bisa ___ ?" (isi dengan aktivitas ekstrem)
3. "Apa Yang Terjadi Jika Kamu ___ ?" (isi dengan skenario berbahaya)`;

        const versionPrompts = {
            '1': `VERSI 1: RELATABLE (REALISTIS)
ATURAN:
- Aktivitas: Begadang, Main Game, Pakai Headset, Minum Kopi, Makan Pedas, Nonton Film, Jogging, Tahan Napas, Tidak Mandi, Main HP, Duduk, Makan Pizza, Minum Energi Drink, Merokok, Vape
- Organ: Otak, Paru-paru, Jantung, Mata, Telinga, Lambung, Kulit, Kaki, Leher, Ginjal
- Kata kerja: ERROR, MENJERIT, BUTA, MELELEH, MELEDAK, RUSAK, MATI RASA, BEKU, PATAH, BOCOR, HITAM, LUMPUH, HANCUR

Contoh:
- Berapa Jam Begadang Sampai Otakmu ERROR?
- Berapa Lama Kamu Bisa Tahan Napas Sampai Parumu Menjerit?
- Apa Yang Terjadi Jika Kamu Minum Kopi 20 Gelas Sehari?`,

            '11': `VERSI 11: PETUALANGAN EPIK
TEMA: ${petualanganSelect.options[petualanganSelect.selectedIndex]?.text || 'Bajak Laut'}

ATURAN KHUSUS PETUALANGAN:
- Aktivitas: Mencari harta karun, Bertarung dengan monster, Menjelajah gua, Memanjang tebing, Berenang di lautan badai, Terbang dengan naga, Melawan pasukan zombi, Bertahan di pulau terpencil
- Organ: Jantung, Paru-paru, Otak, Mata, Tangan, Kaki, Tulang, Darah, Adrenalin
- Kata kerja: HANCUR, MELEDAK, ROBEK, PATAH, LUMPUH, HILANG, TERBAKAR, MEMBATU, TERKUTUK

Contoh:
- Berapa Hari Berlayar Mencari Harta Karun Sampai Jantungmu HANCUR?
- Berapa Lama Kamu Bisa Bertahan di Pulau Terkutuk?
- Apa Yang Terjadi Jika Kamu Melawan Kraken Raksasa?`
        };

        const fullPrompt = basePrompt + '\n\n' + (versionPrompts[version] || versionPrompts['1']) + '\n\nTulis nomor 1-5 saja. Hanya judul. Gunakan variasi 3 format berbeda.';

        const body = {
            model: GROQ_MODEL,
            messages: [{ role: "user", content: fullPrompt }],
            temperature: 1.0,
            max_tokens: 1200
        };

        const resp = await fetch(GROQ_URL, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (!resp.ok) {
            const errData = await resp.json().catch(() => ({}));
            const error = new Error(errData.error?.message || `HTTP Error ${resp.status}`);
            error.rawResponse = JSON.stringify(errData, null, 2);
            throw error;
        }

        const data = await resp.json();
        const content = data.choices[0]?.message?.content || "";
        
        if (!content) {
            throw new Error('Response kosong dari API');
        }

        const lines = content.split('\n').filter(l => l.trim().match(/^\d+\./));
        const ideas = [];
        
        for (let line of lines) {
            const withoutNumber = line.replace(/^\d+\.\s*/, '').trim();
            if (withoutNumber) ideas.push(withoutNumber);
        }
        
        if (ideas.length === 0) {
            const error = new Error('Tidak ada ide yang dihasilkan dari response');
            error.rawResponse = content;
            throw error;
        }
        
        return ideas.slice(0, 5);
    }

    async function callGroqForScript(apiKey, ideaTitle, version, petualanganTheme = 'bajaklaut') {
        const themeSettings = {
            'bajaklaut': {
                environment: 'kapal bajak laut di tengah lautan, pulau harta karun, gua bawah laut',
                props: 'pedang, pistol kuno, kompas, peta harta karun, peti emas, tengkorak, botol rum',
                lighting: 'cahaya matahari terbenam di laut, cahaya obor di dalam gua, badai petir',
                enemies: 'kraken, bajak laut lain, monster laut'
            },
            'samurai': {
                environment: 'Jepang kuno, kuil, gunung Fuji, medan perang',
                props: 'katana, wakizashi, baju samurai, topeng, shuriken',
                lighting: 'cahaya matahari terbit, senja merah, cahaya lentera kertas',
                enemies: 'ronin, ninja, oni (iblis), shogun jahat'
            }
        };

        const theme = themeSettings[petualanganTheme] || themeSettings['bajaklaut'];

        const systemPrompt = `You are a video scriptwriter for a viral YouTube Shorts channel with PETUALANGAN EPIK theme.

TEMA PETUALANGAN: ${petualanganTheme}
LINGKUNGAN: ${theme.environment}
PROPERTI: ${theme.props}
PENCAHAYAAN: ${theme.lighting}
MUSUH: ${theme.enemies}

Write a script in INDONESIAN language based on this title: "${ideaTitle}"

**PENTING: DURASI VIDEO 50-70 DETIK, SETIAP SCENE 2-3 KALIMAT SAJA**

**FORMAT NASKAH YANG BENAR:**

[JUDUL]

Selama [waktu 1], [2-3 kalimat tentang aksi dan kondisi fisik].

Selama [waktu 2], [2-3 kalimat tentang tantangan dan kondisi organ].

Selama [waktu 3], [2-3 kalimat tentang konflik dan organ semakin tertekan].

Selama [waktu 4], [2-3 kalimat tentang klimaks dan organ di ambang batas].

Akhirnya, pada [waktu 5], [2-3 kalimat tentang kegagalan total dan organ HANCUR].

**CONTOH NASKAH:**

Berapa Jam Bertarung Sampai Jantungku HANCUR?

Selama 1 jam, kamu berdiri di atas tebing curam dengan angin gunung membawa aroma pinus yang segar. Jantungmu berdetak penuh semangat, katana di punggung siap melindungi diri. Baju samurai yang kamu kenakan berhembus oleh angin, memantulkan cahaya matahari pagi.

Selama 3 jam, kamu mulai merasakan luka goresan di lengan dan kaki. Jantungmu berdetak lebih kencang, memompa darah keluar dari pembuluh yang robek. Napasmu mulai tersengal, tapi musuh terus berdatangan tanpa henti.

Selama 6 jam, pedang musuh berhasil menusuk dadamu tepat di dekat jantung. Darah mengalir deras membasahi baju zirah yang mulai hancur. Kamu merasakan jantung berdetak tidak beraturan, seperti ingin berhenti kapan saja.

Selama 12 jam, kamu sudah tidak bisa membedakan mana musuh dan mana kawan. Jantungmu berdetak begitu lemah, setiap detak terasa seperti pukulan palu di dada. Lututmu goyah, tubuh hampir roboh, tapi kamu masih berdiri.

Akhirnya, pada jam ke-24, jantungmu HANCUR total. Kamu roboh di puncak gunung, katana patah di samping tubuh, sementara jantung yang hancur berserakan di rongga dada transparan. Matahari terbit menyinari kekalahanmu.

**SETELAH SCRIPT, BUAT 5 SCENE BREAKDOWN DENGAN FORMAT:**

For EACH scene, use this EXACT formula:

**RUMUS PROMPT: "Place the skeleton character" + [AKSI DINAMIS] + [KONTEKS LINGKUNGAN] + [DETAIL PROPERTI] + [TIPE CAHAYA] + [SUDUT KAMERA] + [EFEK VISUAL] + "Rendered in clean cinematic 3D, highly detailed."**

Format output:
===SCRIPT===
(script lengkap dengan format "Selama X..." seperti contoh di atas)
===SCENES===
Scene 1:
Time: [waktu dari script]
Environment: [lokasi]
Image prompt: [Place the skeleton character... Rendered in clean cinematic 3D, highly detailed.]
Video prompt: [Deskripsi gerakan kamera dan karakter]`;

        const body = {
            model: GROQ_MODEL,
            messages: [{ role: "user", content: systemPrompt }],
            temperature: 0.9,
            max_tokens: 6000
        };

        const resp = await fetch(GROQ_URL, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (!resp.ok) {
            const errData = await resp.json().catch(() => ({}));
            const error = new Error(errData.error?.message || `HTTP Error ${resp.status}`);
            error.rawResponse = JSON.stringify(errData, null, 2);
            throw error;
        }

        const data = await resp.json();
        const fullContent = data.choices[0]?.message?.content || "";
        
        if (!fullContent) {
            throw new Error('Response kosong dari API');
        }

        if (!fullContent.includes("===SCRIPT===") || !fullContent.includes("===SCENES===")) {
            const error = new Error('Format response tidak sesuai. Expected ===SCRIPT=== and ===SCENES=== markers.');
            error.rawResponse = fullContent;
            throw error;
        }

        const parts = fullContent.split("===SCENES===");
        const scriptPart = parts[0].replace("===SCRIPT===", "").trim();
        const scenesPart = parts[1] || "";

        const sceneRegex = /Scene\s*\d+.*?:\s*Time:\s*(.*?)\s*Environment:\s*(.*?)\s*Image prompt:\s*(.*?)\s*Video prompt:\s*(.*?)(?=\n\s*Scene|\n*$)/gis;
        const scenes = [];
        let match;
        
        while ((match = sceneRegex.exec(scenesPart)) !== null) {
            scenes.push({
                time: match[1].trim(),
                environment: match[2].trim(),
                imagePrompt: match[3].trim(),
                videoPrompt: match[4].trim()
            });
        }

        if (scenes.length === 0) {
            const error = new Error('Tidak ada scene yang ditemukan dalam response');
            error.rawResponse = scenesPart;
            throw error;
        }

        return { script: scriptPart, scenes: scenes };
    }

    window.copyText = copyText;
    window.toggleFullPrompt = toggleFullPrompt;
</script>
</body>
</html>
