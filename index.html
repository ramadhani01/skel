<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>batas ¬∑ manusia ‚Äî video idea generator</title>
    <!-- Plus Jakarta Sans untuk logo dan judul -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Inter untuk lainnya -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300..700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", sans-serif;
            background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 1.8rem;
            color: #333333;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .logo-container {
            text-align: center;
            margin: 0.5rem 0 2.5rem 0;
        }
        .logo-container h1 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 2.8rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #a855f7, #d946ef);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            text-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
        }
        .logo-container .sub {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 400;
            color: #666666;
            font-size: 1rem;
            margin-top: 0.25rem;
            letter-spacing: 0.3px;
            text-shadow: 0 0 10px rgba(168, 85, 247, 0.2);
        }

        .card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border-radius: 2.5rem;
            padding: 2.2rem 2.2rem;
            box-shadow: 0 25px 50px -12px rgba(168, 85, 247, 0.2), 0 4px 18px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(168, 85, 247, 0.2);
            transition: all 0.2s ease;
        }

        .api-key-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 1rem 1.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.8rem;
            border: 1px solid rgba(168, 85, 247, 0.3);
            box-shadow: 0 10px 15px -3px rgba(168, 85, 247, 0.1);
        }
        .api-key-label {
            font-weight: 600;
            color: #a855f7;
            min-width: 90px;
            font-size: 0.95rem;
        }
        .api-key-input {
            flex: 1;
            min-width: 220px;
            padding: 0.7rem 1.3rem;
            border-radius: 3rem;
            border: 2px solid #e5e7eb;
            font-family: 'Inter', monospace;
            font-size: 0.9rem;
            background: white;
            color: #333333;
            outline: none;
            transition: 0.15s;
        }
        .api-key-input:focus {
            border-color: #a855f7;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
        }
        .api-key-hint {
            font-size: 0.8rem;
            color: #666666;
            width: 100%;
            margin-top: 0.2rem;
        }

        .button-generate {
            background: linear-gradient(135deg, #a855f7, #d946ef);
            border: none;
            padding: 0.8rem 2.2rem;
            border-radius: 3rem;
            font-weight: 600;
            font-size: 1rem;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            cursor: pointer;
            box-shadow: 0 10px 25px -5px rgba(168, 85, 247, 0.3);
            transition: 0.2s;
            letter-spacing: 0.01em;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .button-generate:hover {
            background: linear-gradient(135deg, #9333ea, #c026d3);
            box-shadow: 0 15px 30px -5px rgba(168, 85, 247, 0.4);
            transform: scale(1.02);
        }

        .button-generate:disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(0.3);
        }

        .button-secondary {
            background: white;
            border: 1.5px solid #a855f7;
            padding: 0.5rem 1.5rem;
            border-radius: 3rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: #a855f7;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.1);
            transition: 0.1s;
        }
        .button-secondary:hover {
            background: #a855f7;
            color: white;
            border-color: #d946ef;
        }

        .idea-grid {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin: 1.5rem 0 1.5rem;
        }

        .idea-item {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 0.9rem 1.5rem;
            border-left: 8px solid #a855f7;
            box-shadow: 0 10px 15px -3px rgba(168, 85, 247, 0.1);
            transition: 0.15s ease;
            cursor: pointer;
            border: 1px solid rgba(168, 85, 247, 0.2);
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .idea-item:hover {
            background: white;
            border-left-width: 12px;
            border-left-color: #d946ef;
            box-shadow: 0 15px 20px -5px rgba(168, 85, 247, 0.2);
        }

        .idea-item.selected {
            background: white;
            border-left-color: #d946ef;
            border: 2px solid #a855f7;
            box-shadow: 0 8px 25px rgba(168, 85, 247, 0.2);
        }

        .idea-number {
            width: 2.3rem;
            height: 2.3rem;
            background: linear-gradient(135deg, #a855f7, #d946ef);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            font-size: 0.9rem;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.3);
        }

        .idea-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333333;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .script-output {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(16px);
            border-radius: 2.5rem;
            padding: 1.8rem;
            border: 1px solid rgba(168, 85, 247, 0.2);
            box-shadow: 0 20px 40px -15px rgba(168, 85, 247, 0.15);
            margin-top: 2rem;
        }

        .script-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #a855f7;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .script-text {
            font-size: 1.1rem;
            line-height: 1.6;
            white-space: pre-wrap;
            color: #333333;
            font-weight: 400;
            border-left: 4px solid #a855f7;
            padding-left: 1.3rem;
        }

        .scene-prompt {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 1.3rem;
            margin: 1.5rem 0 0.5rem;
            border: 1px dashed #a855f7;
        }

        .scene-title {
            font-weight: 700;
            color: #a855f7;
            margin-bottom: 0.8rem;
            font-size: 1.2rem;
        }

        .prompt-container {
            background: white;
            border-radius: 1.3rem;
            padding: 0.9rem 1.2rem;
            margin-bottom: 0.8rem;
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .badge {
            background: linear-gradient(135deg, #a855f7, #d946ef);
            border-radius: 3rem;
            padding: 0.2rem 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            display: inline-block;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.2);
        }

        .copy-btn {
            background: none;
            border: 1px solid #a855f7;
            color: #a855f7;
            padding: 0.2rem 1rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.1s;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .copy-btn:hover {
            background: #a855f7;
            color: white;
        }

        .copy-btn.copied {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .prompt-text {
            font-size: 0.9rem;
            color: #333333;
            line-height: 1.5;
            word-break: break-word;
        }

        .prompt-full {
            display: none;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #a855f7;
        }

        .show-more {
            color: #a855f7;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 0.25rem;
            display: inline-block;
        }

        hr {
            border: 0.5px solid rgba(168, 85, 247, 0.2);
            margin: 1.2rem 0;
        }

        .action-bottom {
            display: flex;
            justify-content: center;
            margin: 1rem 0 0.2rem;
        }

        .selected-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            border-radius: 4rem;
            padding: 0.5rem 1.5rem;
            margin: 1rem 0 0.5rem;
            border: 1px solid #a855f7;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.1);
        }

        #selectedDisplay {
            color: #a855f7;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .footer-credit {
            text-align: center;
            color: #a855f7;
            margin-top: 2rem;
            font-size: 0.8rem;
        }

        .error-message {
            background: #fee2e2;
            color: #b91c1c;
            padding: 0.8rem 1.5rem;
            border-radius: 3rem;
            margin: 1rem 0;
            border: 1px solid #ef4444;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .raw-response {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: monospace;
            font-size: 0.8rem;
            padding: 1rem;
            border-radius: 1rem;
            margin-top: 1rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow: auto;
        }

        .get-key-link {
            color: #a855f7;
            font-weight: 600;
            text-decoration: none;
            border-bottom: 1px dashed #a855f7;
        }
        .get-key-link:hover {
            color: #d946ef;
        }

        .audio-player-container {
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 2rem;
            border: 1px solid rgba(168, 85, 247, 0.3);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .audio-player-container audio {
            width: 100%;
            height: 40px;
            border-radius: 2rem;
        }

        .audio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #a855f7;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .voice-badge {
            background: rgba(168, 85, 247, 0.15);
            border: 1px solid #a855f7;
            color: #a855f7;
            padding: 0.2rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            margin-left: 0.5rem;
        }

        .loading-audio {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #a855f7;
            font-size: 0.9rem;
            padding: 0.5rem;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(168, 85, 247, 0.3);
            border-top-color: #a855f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .eye-tip {
            background: rgba(168, 85, 247, 0.1);
            border-left: 4px solid #a855f7;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            margin: 0.5rem 0;
            font-size: 0.8rem;
            color: #666;
        }
        .eye-tip strong {
            color: #a855f7;
        }

        .duration-badge {
            background: #10b981;
            color: white;
            padding: 0.2rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-block;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="logo-container">
        <h1>batas ¬∑ manusia</h1>
        <div class="sub">biological failure in silent visuals</div>
    </div>

    <div class="card">
        <div class="api-key-container">
            <span class="api-key-label">üîë Groq Key</span>
            <input type="password" id="apiKeyInput" class="api-key-input" placeholder="gsk_...">
            <div class="api-key-hint">
                <a href="https://console.groq.com/keys" target="_blank" class="get-key-link">Get API key</a>
            </div>
        </div>

        <div class="api-key-container">
            <span class="api-key-label">üé§ ElevenLabs Key</span>
            <input type="password" id="elevenLabsKeyInput" class="api-key-input" placeholder="elevenlabs_...">
            <div class="api-key-hint">
                <a href="https://elevenlabs.io/app/settings/api-keys" target="_blank" class="get-key-link">Get API key</a> (optional)
                <span class="voice-badge">‚ú® Rachel</span>
            </div>
        </div>

        <div id="ideaList" class="idea-grid">
            <div style="text-align: center; color: #666666; padding: 1.5rem; font-style: italic; font-size: 0.95rem;">
                Enter API Key, then generate
            </div>
        </div>

        <div id="selectedArea" style="display: none;">
            <div class="selected-bar">
                <span id="selectedDisplay">‚úî selected idea: </span>
                <button id="generateScriptBtn" class="button-secondary">üé¨ generate script</button>
            </div>
        </div>

        <div class="action-bottom">
            <button id="generateIdeasBtn" class="button-generate">
                <span>‚ú®</span> generate 5 fresh ideas
            </button>
        </div>
    </div>

    <div id="scriptContainer" class="script-output" style="display: none;">
        <div class="script-label">
            script (indonesian) ¬∑ 45‚Äì70 seconds 
            <span class="duration-badge">‚è±Ô∏è target: 9-12 kalimat</span>
        </div>
        <div id="scriptText" class="script-text"></div>
        
        <div class="eye-tip">
            <strong>üëÅÔ∏è EYE DETAIL INCLUDED:</strong> Every prompt includes "bright yellow glowing irises with dark pupils" - eyes visible in ALL scenes.
        </div>
        
        <div id="audioContainer" style="display: none;" class="audio-player-container">
            <div class="audio-label">
                <span>üéµ Rachel voice</span>
            </div>
            <audio id="audioPlayer" controls preload="metadata">
                <source src="" type="audio/mpeg">
                Your browser does not support audio player.
            </audio>
            <div id="audioLoading" class="loading-audio" style="display: none;">
                <div class="spinner"></div>
                <span>Generating audio...</span>
            </div>
        </div>

        <hr>
        <div class="script-label">image prompts (english ‚Äî with EYE DETAILS)</div>
        <div id="scenePrompts"></div>
        <div id="debugResponse" style="display: none;" class="raw-response"></div>
    </div>

    <div class="footer-credit">
        [Subject] + [Action] + [EYES: yellow irises] + [Environment] + [Lighting] + [Camera] + Render 3D ¬∑ 45-70s script
    </div>
</div>

<script>
    const GROQ_URL = "https://api.groq.com/openai/v1/chat/completions";
    const GROQ_MODEL = "llama-3.3-70b-versatile";
    const ELEVENLABS_URL = "https://api.elevenlabs.io/v1";
    const RACHEL_VOICE_ID = "21m00Tcm4TlvDq8ikWAM";
    
    const STORAGE_KEYS = {
        GROQ_API_KEY: 'batasManusia_groqKey',
        ELEVENLABS_API_KEY: 'batasManusia_elevenLabsKey'
    };
    
    let generatedIdeas = [];
    let selectedIdeaIndex = null;

    const generateIdeasBtn = document.getElementById('generateIdeasBtn');
    const ideaListDiv = document.getElementById('ideaList');
    const selectedArea = document.getElementById('selectedArea');
    const selectedDisplay = document.getElementById('selectedDisplay');
    const generateScriptBtn = document.getElementById('generateScriptBtn');
    const scriptContainer = document.getElementById('scriptContainer');
    const scriptTextDiv = document.getElementById('scriptText');
    const scenePromptsDiv = document.getElementById('scenePrompts');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const elevenLabsKeyInput = document.getElementById('elevenLabsKeyInput');
    const debugResponse = document.getElementById('debugResponse');
    
    const audioContainer = document.getElementById('audioContainer');
    const audioPlayer = document.getElementById('audioPlayer');
    const audioLoading = document.getElementById('audioLoading');

    function loadSavedKeys() {
        const savedGroqKey = localStorage.getItem(STORAGE_KEYS.GROQ_API_KEY);
        if (savedGroqKey) apiKeyInput.value = savedGroqKey;
        
        const savedElevenLabsKey = localStorage.getItem(STORAGE_KEYS.ELEVENLABS_API_KEY);
        if (savedElevenLabsKey) elevenLabsKeyInput.value = savedElevenLabsKey;
    }

    function saveApiKey(key, value) {
        if (value) localStorage.setItem(key, value);
        else localStorage.removeItem(key);
    }

    function getApiKey() { return apiKeyInput.value.trim(); }
    function getElevenLabsKey() { return elevenLabsKeyInput.value.trim(); }
    function isValidApiKey(key) { return key.startsWith('gsk_') && key.length > 20; }

    apiKeyInput.addEventListener('input', () => saveApiKey(STORAGE_KEYS.GROQ_API_KEY, getApiKey()));
    elevenLabsKeyInput.addEventListener('input', () => saveApiKey(STORAGE_KEYS.ELEVENLABS_API_KEY, getElevenLabsKey()));

    async function generateAudioFile(text) {
        const apiKey = getElevenLabsKey();
        if (!apiKey) { audioContainer.style.display = 'none'; return null; }

        try {
            audioLoading.style.display = 'flex';
            audioContainer.style.display = 'block';
            audioPlayer.src = '';
            
            const response = await fetch(`${ELEVENLABS_URL}/text-to-speech/${RACHEL_VOICE_ID}`, {
                method: 'POST',
                headers: {
                    'xi-api-key': apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: text,
                    model_id: 'eleven_multilingual_v2',
                    voice_settings: { stability: 0.75, similarity_boost: 0.75, style: 0.0, speed: 1.0, use_speaker_boost: true }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail?.message || 'Failed to generate audio');
            }

            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            audioPlayer.src = audioUrl;
            audioPlayer.load();
            audioLoading.style.display = 'none';
            return audioUrl;
            
        } catch (error) {
            console.error('TTS error:', error);
            audioLoading.style.display = 'none';
            audioContainer.style.display = 'none';
            return null;
        }
    }

    generateIdeasBtn.addEventListener('click', async () => {
        const apiKey = getApiKey();
        
        if (!apiKey) {
            ideaListDiv.innerHTML = `<div class="error-message">‚ùå Enter API Key</div>`;
            return;
        }
        
        if (!isValidApiKey(apiKey)) {
            ideaListDiv.innerHTML = `<div class="error-message">‚ùå Key must start with "gsk_" + min 20 characters</div>`;
            return;
        }

        generateIdeasBtn.disabled = true;
        generateIdeasBtn.innerHTML = '‚è≥ processing...';
        ideaListDiv.innerHTML = `<div style="padding: 1.5rem; color:#666666; text-align:center;">‚è≥ finding 5 fresh ideas...</div>`;

        try {
            const ideas = await callGroqForIdeas(apiKey);
            generatedIdeas = ideas;
            renderIdeaList(ideas);
            selectedArea.style.display = 'none';
            scriptContainer.style.display = 'none';
            selectedIdeaIndex = null;
            
        } catch (e) {
            if (e.message.includes('401') || e.message.includes('Invalid API Key')) {
                ideaListDiv.innerHTML = `<div class="error-message">‚ùå Invalid API Key. <a href="https://console.groq.com/keys" target="_blank" style="color:#b91c1c;">Check here</a></div>`;
            } else {
                ideaListDiv.innerHTML = `<div class="error-message">‚ùå Failed: ${e.message}</div>`;
            }
        } finally {
            generateIdeasBtn.disabled = false;
            generateIdeasBtn.innerHTML = '‚ú® generate 5 fresh ideas';
        }
    });

    function selectIdea(index) {
        selectedIdeaIndex = index;
        const items = document.querySelectorAll('.idea-item');
        items.forEach((item, i) => {
            if (i === index) item.classList.add('selected');
            else item.classList.remove('selected');
        });
        selectedDisplay.innerText = `‚úî selected idea: ${generatedIdeas[index]}`;
        selectedArea.style.display = 'block';
        scriptContainer.style.display = 'none';
    }

    function renderIdeaList(ideas) {
        if (!ideas || ideas.length === 0) {
            ideaListDiv.innerHTML = `<div style="padding:1.5rem; text-align:center;">no ideas</div>`;
            return;
        }
        let html = '';
        ideas.forEach((idea, idx) => {
            html += `
                <div class="idea-item" data-index="${idx}">
                    <div class="idea-number">${idx+1}</div>
                    <div class="idea-content">
                        <div class="idea-title">${idea}</div>
                    </div>
                </div>
            `;
        });
        ideaListDiv.innerHTML = html;
        document.querySelectorAll('.idea-item').forEach((el) => {
            el.addEventListener('click', (e) => {
                const index = parseInt(el.dataset.index, 10);
                selectIdea(index);
            });
        });
    }

    async function copyText(button, text) {
        try {
            await navigator.clipboard.writeText(text);
            button.classList.add('copied');
            button.innerHTML = '‚úì copied';
            setTimeout(() => {
                button.classList.remove('copied');
                button.innerHTML = 'üìã copy';
            }, 2000);
        } catch (err) {
            alert('Failed to copy text');
        }
    }

    function toggleFullPrompt(showMoreEl) {
        const fullDiv = showMoreEl.parentElement.querySelector('.prompt-full');
        if (fullDiv.style.display === 'none' || !fullDiv.style.display) {
            fullDiv.style.display = 'block';
            showMoreEl.textContent = 'show less';
        } else {
            fullDiv.style.display = 'none';
            showMoreEl.textContent = 'show more';
        }
    }

    function detectFramingType(text) {
        const t = text.toLowerCase();
        
        if (t.includes("close-up") || t.includes("closeup")) return "close-up";
        if (t.includes("medium shot")) return "medium shot";
        if (t.includes("wide shot")) return "wide shot";
        if (t.includes("low-angle")) return "low-angle shot";
        if (t.includes("high-angle")) return "high-angle shot";
        return "full-body shot";
    }

    generateScriptBtn.addEventListener('click', async () => {
        if (selectedIdeaIndex === null || !generatedIdeas[selectedIdeaIndex]) return;

        const apiKey = getApiKey();
        if (!apiKey || !isValidApiKey(apiKey)) {
            alert('Invalid API Key');
            return;
        }

        const selectedIdea = generatedIdeas[selectedIdeaIndex];
        generateScriptBtn.disabled = true;
        generateScriptBtn.innerHTML = '‚è≥ writing script...';
        scriptContainer.style.display = 'block';
        scriptTextDiv.innerText = 'Waiting for Groq...';
        scenePromptsDiv.innerHTML = '';
        debugResponse.style.display = 'none';
        audioContainer.style.display = 'none';

        try {
            const result = await callGroqForScript(apiKey, selectedIdea);
            
            scriptTextDiv.innerText = result.script;

            if (getElevenLabsKey()) {
                await generateAudioFile(result.script);
            }

            let scenesHtml = '';
            result.scenes.forEach((scene, idx) => {
                const framingType = detectFramingType(scene.imagePrompt);
                
                scenesHtml += `
                    <div class="scene-prompt">
                        <div class="scene-title">‚è±Ô∏è ${scene.time} ¬∑ ${framingType}</div>
                        
                        <div class="prompt-container">
                            <div class="prompt-header">
                                <span class="badge">üñºÔ∏è IMAGE PROMPT</span>
                                <button class="copy-btn" onclick="copyText(this, \`${scene.imagePrompt.replace(/`/g, '\\`')}\`)">üìã copy</button>
                            </div>
                            <div class="prompt-text">${scene.imagePrompt.substring(0, 200)}...</div>
                            <div class="prompt-full">${scene.imagePrompt}</div>
                            <span class="show-more" onclick="toggleFullPrompt(this)">show more</span>
                        </div>

                        <div class="prompt-container">
                            <div class="prompt-header">
                                <span class="badge">üé• VIDEO PROMPT</span>
                                <button class="copy-btn" onclick="copyText(this, \`${scene.videoPrompt.replace(/`/g, '\\`')}\`)">üìã copy</button>
                            </div>
                            <div class="prompt-text">${scene.videoPrompt.substring(0, 150)}...</div>
                            <div class="prompt-full">${scene.videoPrompt}</div>
                            <span class="show-more" onclick="toggleFullPrompt(this)">show more</span>
                        </div>
                    </div>
                `;
            });
            scenePromptsDiv.innerHTML = scenesHtml;
            
        } catch (e) {
            console.error('Error:', e);
            scriptTextDiv.innerText = '‚ùå FAILED: ' + e.message;
            if (e.rawResponse) {
                debugResponse.textContent = 'Raw Response:\n' + e.rawResponse;
                debugResponse.style.display = 'block';
            }
        } finally {
            generateScriptBtn.disabled = false;
            generateScriptBtn.innerHTML = 'üé¨ generate script';
        }
    });

    loadSavedKeys();

    async function callGroqForIdeas(apiKey) {
        const prompt = `Create 5 short video titles in QUESTION format about human body limits in Indonesian language.

MANDATORY FORMAT: "Berapa [TIME UNIT] [ACTIVITY] Sampai [ORGAN/BODY PART] [EXTREME VERB]?"

RULES:
1. Time units: Jam (Hours), Menit (Minutes), Detik (Seconds), Hari (Days), Potong (Pieces), Botol (Bottles), Batang (Sticks), Kali (Times)
2. Activities: Begadang (Staying up late), Main Game (Gaming), Pakai Headset (Using headset), Minum Kopi (Drinking coffee), Makan Pedas (Eating spicy food), Nonton Film (Watching movies), Jogging, Tahan Napas (Holding breath), Tidak Mandi (Not bathing), Tatap Matahari (Staring at sun), Main HP (Using phone), Duduk (Sitting), Makan Pizza (Eating pizza), Minum Energi Drink (Drinking energy drinks), Merokok (Smoking)
3. Organs: Otak (Brain), Paru-paru (Lungs), Jantung (Heart), Mata (Eyes), Telinga (Ears), Lambung (Stomach), Kulit (Skin), Kaki (Feet), Leher (Neck), Ginjal (Kidneys)
4. Extreme verbs: ERROR, MENJERIT (SCREAMING), JADI BATU (TURN TO STONE), BUTA (BLIND), MELELEH (MELTING), MELEDAK (EXPLODING), RUSAK (BROKEN), MATI RASA (NUMB), BEKU (FROZEN), PATAH (FRACTURED), BOCOR (LEAKING), HITAM (BLACK), LUMPUH (PARALYZED), HANCUR (DESTROYED)

Write numbers 1-5 only. Titles only in Indonesian. Create fresh variations.

Example:
- Berapa Jam Begadang Sampai Otakmu ERROR?
- Berapa Batang Rokok Sampai Paru-Parumu HANCUR?`;

        const body = {
            model: GROQ_MODEL,
            messages: [{ role: "user", content: prompt }],
            temperature: 1.0,
            max_tokens: 800
        };

        try {
            const resp = await fetch(GROQ_URL, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!resp.ok) {
                const errData = await resp.json().catch(() => ({}));
                throw new Error(errData.error?.message || `Error ${resp.status}`);
            }

            const data = await resp.json();
            const content = data.choices[0]?.message?.content || "";
            const lines = content.split('\n').filter(l => l.trim().match(/^\d+\./));
            const ideas = [];
            
            for (let line of lines) {
                const withoutNumber = line.replace(/^\d+\.\s*/, '').trim();
                if (withoutNumber) ideas.push(withoutNumber);
            }
            
            if (ideas.length === 0) throw new Error('No ideas generated');
            return ideas.slice(0, 5);
            
        } catch (error) {
            console.error('Error:', error);
            throw error;
        }
    }

    async function callGroqForScript(apiKey, ideaTitle) {
        const systemPrompt = `You are a video scriptwriter for a viral YouTube Shorts channel. 

Write a script in INDONESIAN language based on this title: "${ideaTitle}"

WRITING STYLE: Calm, clinical but conversational, second-person ("kamu" - "you"), short sentences.

**DURATION REQUIREMENT (CRITICAL - MUST FOLLOW):**
- Script MUST be 45-70 seconds when spoken aloud (120-180 words in Indonesian)
- Use this EXACT structure for proper timing:

| Section | Sentences | Duration | Word Count |
|---------|-----------|----------|------------|
| Opening (Title + Hook) | 2 sentences | 8-12 seconds | 20-30 words |
| Timeline Point 1 | 1-2 sentences | 6-8 seconds | 15-20 words |
| Timeline Point 2 | 1-2 sentences | 6-8 seconds | 15-20 words |
| Timeline Point 3 | 1-2 sentences | 6-8 seconds | 15-20 words |
| Timeline Point 4 | 1-2 sentences | 6-8 seconds | 15-20 words |
| Timeline Point 5 | 1-2 sentences | 6-8 seconds | 15-20 words |
| Timeline Point 6 (optional) | 1-2 sentences | 6-8 seconds | 15-20 words |
| Closing (Climax + Final) | 2 sentences | 7-10 seconds | 15-25 words |
| **TOTAL** | **9-12 sentences** | **45-70 seconds** | **120-180 words** |

EXAMPLE with 58 seconds (10 sentences, 145 words) for "Berapa Batang Rokok Sampai Paru-Parumu HANCUR?":
1. Berapa Batang Rokok Sampai Paru-Parumu HANCUR? (3s, 7 kata)
2. Tanpa kamu sadari, paru-parumu sedang mengalami kerusakan yang tidak dapat diperbaiki. (5s, 8 kata)
3. Selama 1 tahun pertama, kamu masih merasa sehat. Paru-parumu masih dapat bernapas dengan baik. (7s, 12 kata)
4. Memasuki tahun ke-5, kamu mulai merasakan sesak napas saat berolahraga. Paru-parumu mulai meradang. (8s, 14 kata)
5. Di tahun ke-10, fibrosis mulai terbentuk. Setiap tarikan napas terasa seperti menusuk. (7s, 12 kata)
6. Tahun ke-15, paru-parumu mulai menghitam. Batuk kronis tidak pernah berhenti. (6s, 11 kata)
7. Memasuki tahun ke-20, oksigen sudah tidak bisa masuk. Paru-parumu HANCUR total. (7s, 11 kata)
8. Kamu roboh. Napas terakhir. Tubuhmu menyerah. (5s, 6 kata)

**RULE SUMMARY:**
- Total: 9-12 kalimat bahasa Indonesia
- 120-180 kata total
- 5-7 poin timeline (sesuaikan dengan judul: gunakan tahun untuk rokok, jam untuk begadang, detik untuk tahan napas, dll)
- Akhiri dengan kegagalan total yang dramatis

After the script, create 3-5 scene breakdowns. For EACH scene, use this EXACT formula for image prompts:

**PROMPT FORMULA: [SUBJECT] + [ACTION/POSE] + [EYE DESCRIPTION] + [ENVIRONMENT CONTEXT] + [PROPERTY DETAILS] + [LIGHTING TYPE] + [CAMERA ANGLE] + [VISUAL EFFECTS] + [RENDER STYLE]**

**CRITICAL RULES FOR EYES (MUST FOLLOW):**
- The skeleton character MUST have visible eyes in EVERY scene
- Base eye description: "bright yellow glowing irises with dark pupils, visible through transparent skull"
- Eye condition MUST change according to scene progression:

| Scene Stage | Eye Description |
|-------------|-----------------|
| Early / Healthy | "bright yellow glowing irises with dark pupils, eyes clear and alert, glowing warmly" |
| Mid / Strained | "bright yellow irises with dark pupils, eyes showing visible strain, glow slightly dimmed" |
| Late / Damaged | "yellow irises flickering and dimming, pupils irregular, glow fading, dark circles forming" |
| Final / Catastrophic | "eyes completely dark and lifeless, no glow remaining, milky film covering the irises" |

**EXAMPLE WITH EYES INCLUDED (smoking theme):**

Scene 1 (Year 1 - Healthy):
"Place the skeleton character sitting casually on a modern sofa, holding a freshly lit cigarette between two fingers, smoke curling upward, with **bright yellow glowing irises with dark pupils visible through transparent skull, eyes clear and alert following the smoke**, a clean ashtray on the side table beside a morning coffee cup. Sunlight streams through large windows creating warm natural lighting and long soft shadows. Use a medium wide shot showing the relaxed posture. Add subtle morning haze and gentle sun rays. Rendered in clean cinematic 3D, highly detailed."

Scene 2 (Year 5 - Strained):
"Place the skeleton character slumped on the same sofa, now surrounded by multiple ashtrays overflowing with cigarette butts, holding a cigarette with slightly trembling fingers, with **bright yellow irises with dark pupils, eyes showing visible strain, glow slightly dimmed, dark circles beginning to form**. Harsh late afternoon light creates deep shadows across the room, dust particles visible in the fading light beams. Use a tighter medium shot focusing on the labored breathing. Add subtle smoke haze hanging in the air and discarded cigarette packs on floor. Rendered in clean cinematic 3D, highly detailed."

Scene 3 (Year 10 - Damaged):
"Place the skeleton character hunched forward on the edge of the sofa, one hand clutching its chest where the transparent ribcage reveals lungs turning dark and stiff with fibrous tissue, the other hand weakly holding a smoldering cigarette, with **yellow irises flickering and dimming, pupils irregular, glow fading, deep dark circles around eyes**. Dim table lamp creates harsh dramatic lighting with deep shadows. Use a close-up shot focused on the chest area showing the damaged lungs. Add faint internal glow revealing scarred tissue and wisps of smoke escaping between ribs. Rendered in clean cinematic 3D, highly detailed."

Scene 4 (Year 20 - Catastrophic):
"Place the skeleton character collapsed on the floor beside the sofa, cigarette still clutched in lifeless fingers, the transparent chest cavity fully open revealing lungs completely blackened and crumbling like charcoal, pieces of lung tissue floating away like ash, with **eyes completely dark and lifeless, no yellow glow remaining, milky film covering the irises, staring blankly at the ceiling**. Flickering table lamp creates strobe-like lighting effects, casting long dancing shadows. Use a dramatic low-angle shot showing the final collapse. Add lung fragments disintegrating into smoke particles. Rendered in clean cinematic 3D, highly detailed."

**CRITICAL RULES:**
- Scene 1 MUST show the ACTIVITY from the title
- ALL scenes MUST show progression of that activity
- The character MUST be doing the activity in EVERY scene
- Use "Place the skeleton character" at the START of EVERY image prompt
- **EVERY image prompt MUST include eye description from the table above**
- End EVERY image prompt with "Rendered in clean cinematic 3D, highly detailed."
- ALL prompts must be in ENGLISH

Format output:
===SCRIPT===
(script in Indonesian - 9-12 sentences, 120-180 words, 45-70 seconds)
===SCENES===
Scene 1:
Time: [from script in Indonesian, e.g., "1 tahun"]
Environment: [location in English]
Image prompt: [Place the skeleton character... with eye description... Rendered in clean cinematic 3D, highly detailed.]
Video prompt: [subtle movement description in English]

Scene 2:
...`;

        const body = {
            model: GROQ_MODEL,
            messages: [{ role: "user", content: systemPrompt }],
            temperature: 0.8,
            max_tokens: 8000
        };

        try {
            const resp = await fetch(GROQ_URL, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!resp.ok) {
                const errData = await resp.json().catch(() => ({}));
                throw new Error(errData.error?.message || `Error ${resp.status}`);
            }

            const data = await resp.json();
            const fullContent = data.choices[0]?.message?.content || "";
            const rawResponse = fullContent;

            let scriptPart = "";
            let scenesPart = "";
            
            if (fullContent.includes("===SCRIPT===") && fullContent.includes("===SCENES===")) {
                const parts = fullContent.split("===SCENES===");
                scriptPart = parts[0].replace("===SCRIPT===", "").trim();
                scenesPart = parts[1] || "";
            } else {
                const error = new Error('Response format incorrect. Expected ===SCRIPT=== and ===SCENES=== markers.');
                error.rawResponse = rawResponse;
                throw error;
            }

            const sceneRegex = /Scene\s*\d+.*?:\s*Time:\s*(.*?)\s*Environment:\s*(.*?)\s*Image prompt:\s*(.*?)\s*Video prompt:\s*(.*?)(?=\n\s*Scene|\n*$)/gis;
            const scenes = [];
            let match;
            
            while ((match = sceneRegex.exec(scenesPart)) !== null) {
                scenes.push({
                    time: match[1].trim(),
                    environment: match[2].trim(),
                    imagePrompt: match[3].trim(),
                    videoPrompt: match[4].trim(),
                    narration: scriptPart
                });
            }

            if (scenes.length === 0) {
                const error = new Error('No scenes found in response');
                error.rawResponse = rawResponse;
                throw error;
            }

            return { script: scriptPart, scenes: scenes };
            
        } catch (error) {
            console.error('Error:', error);
            throw error;
        }
    }

    window.copyText = copyText;
    window.toggleFullPrompt = toggleFullPrompt;
</script>
</body>
</html>
