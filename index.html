<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>batas ¬∑ manusia ‚Äî video idea generator</title>
    <!-- Plus Jakarta Sans untuk logo dan judul -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Inter untuk lainnya -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300..700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", sans-serif;
            background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 1.8rem;
            color: #333333;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .logo-container {
            text-align: center;
            margin: 0.5rem 0 2.5rem 0;
        }
        .logo-container h1 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 2.8rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #a855f7, #d946ef);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            text-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
        }
        .logo-container .sub {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 400;
            color: #666666;
            font-size: 1rem;
            margin-top: 0.25rem;
            letter-spacing: 0.3px;
            text-shadow: 0 0 10px rgba(168, 85, 247, 0.2);
        }

        .card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border-radius: 2.5rem;
            padding: 2.2rem 2.2rem;
            box-shadow: 0 25px 50px -12px rgba(168, 85, 247, 0.2), 0 4px 18px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(168, 85, 247, 0.2);
            transition: all 0.2s ease;
        }

        .api-key-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 1rem 1.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.8rem;
            border: 1px solid rgba(168, 85, 247, 0.3);
            box-shadow: 0 10px 15px -3px rgba(168, 85, 247, 0.1);
        }
        .api-key-label {
            font-weight: 600;
            color: #a855f7;
            min-width: 90px;
            font-size: 0.95rem;
        }
        .api-key-input {
            flex: 1;
            min-width: 220px;
            padding: 0.7rem 1.3rem;
            border-radius: 3rem;
            border: 2px solid #e5e7eb;
            font-family: 'Inter', monospace;
            font-size: 0.9rem;
            background: white;
            color: #333333;
            outline: none;
            transition: 0.15s;
        }
        .api-key-input:focus {
            border-color: #a855f7;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
        }
        .api-key-hint {
            font-size: 0.8rem;
            color: #666666;
            width: 100%;
            margin-top: 0.2rem;
        }

        .button-generate {
            background: linear-gradient(135deg, #a855f7, #d946ef);
            border: none;
            padding: 0.8rem 2.2rem;
            border-radius: 3rem;
            font-weight: 600;
            font-size: 1rem;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            cursor: pointer;
            box-shadow: 0 10px 25px -5px rgba(168, 85, 247, 0.3);
            transition: 0.2s;
            letter-spacing: 0.01em;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .button-generate:hover {
            background: linear-gradient(135deg, #9333ea, #c026d3);
            box-shadow: 0 15px 30px -5px rgba(168, 85, 247, 0.4);
            transform: scale(1.02);
        }

        .button-generate:disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(0.3);
        }

        .button-secondary {
            background: white;
            border: 1.5px solid #a855f7;
            padding: 0.5rem 1.5rem;
            border-radius: 3rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: #a855f7;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.1);
            transition: 0.1s;
        }
        .button-secondary:hover {
            background: #a855f7;
            color: white;
            border-color: #d946ef;
        }

        .idea-grid {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin: 1.5rem 0 1.5rem;
        }

        .idea-item {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 0.9rem 1.5rem;
            border-left: 8px solid #a855f7;
            box-shadow: 0 10px 15px -3px rgba(168, 85, 247, 0.1);
            transition: 0.15s ease;
            cursor: pointer;
            border: 1px solid rgba(168, 85, 247, 0.2);
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .idea-item:hover {
            background: white;
            border-left-width: 12px;
            border-left-color: #d946ef;
            box-shadow: 0 15px 20px -5px rgba(168, 85, 247, 0.2);
        }

        .idea-item.selected {
            background: white;
            border-left-color: #d946ef;
            border: 2px solid #a855f7;
            box-shadow: 0 8px 25px rgba(168, 85, 247, 0.2);
        }

        .idea-number {
            width: 2.3rem;
            height: 2.3rem;
            background: linear-gradient(135deg, #a855f7, #d946ef);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            font-size: 0.9rem;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.3);
        }

        .idea-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333333;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .script-output {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(16px);
            border-radius: 2.5rem;
            padding: 1.8rem;
            border: 1px solid rgba(168, 85, 247, 0.2);
            box-shadow: 0 20px 40px -15px rgba(168, 85, 247, 0.15);
            margin-top: 2rem;
        }

        .script-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #a855f7;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .script-text {
            font-size: 1.1rem;
            line-height: 1.6;
            white-space: pre-wrap;
            color: #333333;
            font-weight: 400;
            border-left: 4px solid #a855f7;
            padding-left: 1.3rem;
        }

        .scene-prompt {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 1.3rem;
            margin: 1.5rem 0 0.5rem;
            border: 1px dashed #a855f7;
        }

        .scene-title {
            font-weight: 700;
            color: #a855f7;
            margin-bottom: 0.8rem;
            font-size: 1.2rem;
        }

        .prompt-container {
            background: white;
            border-radius: 1.3rem;
            padding: 0.9rem 1.2rem;
            margin-bottom: 0.8rem;
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .badge {
            background: linear-gradient(135deg, #a855f7, #d946ef);
            border-radius: 3rem;
            padding: 0.2rem 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            display: inline-block;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.2);
        }

        .copy-btn {
            background: none;
            border: 1px solid #a855f7;
            color: #a855f7;
            padding: 0.2rem 1rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.1s;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .copy-btn:hover {
            background: #a855f7;
            color: white;
        }

        .copy-btn.copied {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .prompt-text {
            font-size: 0.9rem;
            color: #333333;
            line-height: 1.5;
            word-break: break-word;
        }

        .prompt-full {
            display: none;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #a855f7;
        }

        .show-more {
            color: #a855f7;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 0.25rem;
            display: inline-block;
        }

        hr {
            border: 0.5px solid rgba(168, 85, 247, 0.2);
            margin: 1.2rem 0;
        }

        .action-bottom {
            display: flex;
            justify-content: center;
            margin: 1rem 0 0.2rem;
        }

        .selected-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            border-radius: 4rem;
            padding: 0.5rem 1.5rem;
            margin: 1rem 0 0.5rem;
            border: 1px solid #a855f7;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.1);
        }

        #selectedDisplay {
            color: #a855f7;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .footer-credit {
            text-align: center;
            color: #a855f7;
            margin-top: 2rem;
            font-size: 0.8rem;
        }

        .error-message {
            background: #fee2e2;
            color: #b91c1c;
            padding: 0.8rem 1.5rem;
            border-radius: 3rem;
            margin: 1rem 0;
            border: 1px solid #ef4444;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .raw-response {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: monospace;
            font-size: 0.8rem;
            padding: 1rem;
            border-radius: 1rem;
            margin-top: 1rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow: auto;
        }

        .get-key-link {
            color: #a855f7;
            font-weight: 600;
            text-decoration: none;
            border-bottom: 1px dashed #a855f7;
        }
        .get-key-link:hover {
            color: #d946ef;
        }

        .audio-player-container {
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 2rem;
            border: 1px solid rgba(168, 85, 247, 0.3);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .audio-player-container audio {
            width: 100%;
            height: 40px;
            border-radius: 2rem;
        }

        .audio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #a855f7;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .voice-badge {
            background: rgba(168, 85, 247, 0.15);
            border: 1px solid #a855f7;
            color: #a855f7;
            padding: 0.2rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            margin-left: 0.5rem;
        }

        .loading-audio {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #a855f7;
            font-size: 0.9rem;
            padding: 0.5rem;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(168, 85, 247, 0.3);
            border-top-color: #a855f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .eye-tip {
            background: rgba(168, 85, 247, 0.1);
            border-left: 4px solid #a855f7;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            margin: 0.5rem 0;
            font-size: 0.8rem;
            color: #666;
        }
        .eye-tip strong {
            color: #a855f7;
        }

        .duration-badge {
            background: #10b981;
            color: white;
            padding: 0.2rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-block;
            margin-left: 0.5rem;
        }

        .scene-count-badge {
            background: #a855f7;
            color: white;
            padding: 0.2rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-block;
            margin-left: 0.5rem;
        }

        .format-badge {
            background: #f59e0b;
            color: white;
            padding: 0.2rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-block;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="logo-container">
        <h1>batas ¬∑ manusia</h1>
        <div class="sub">biological failure in silent visuals</div>
    </div>

    <div class="card">
        <div class="api-key-container">
            <span class="api-key-label">üîë Groq Key</span>
            <input type="password" id="apiKeyInput" class="api-key-input" placeholder="gsk_...">
            <div class="api-key-hint">
                <a href="https://console.groq.com/keys" target="_blank" class="get-key-link">Get API key</a>
            </div>
        </div>

        <div class="api-key-container">
            <span class="api-key-label">üé§ ElevenLabs Key</span>
            <input type="password" id="elevenLabsKeyInput" class="api-key-input" placeholder="elevenlabs_...">
            <div class="api-key-hint">
                <a href="https://elevenlabs.io/app/settings/api-keys" target="_blank" class="get-key-link">Get API key</a> (optional)
                <span class="voice-badge">‚ú® Rachel</span>
            </div>
        </div>

        <div id="ideaList" class="idea-grid">
            <div style="text-align: center; color: #666666; padding: 1.5rem; font-style: italic; font-size: 0.95rem;">
                Enter API Key, then generate
            </div>
        </div>

        <div id="selectedArea" style="display: none;">
            <div class="selected-bar">
                <span id="selectedDisplay">‚úî selected idea: </span>
                <button id="generateScriptBtn" class="button-secondary">üé¨ generate script</button>
            </div>
        </div>

        <div class="action-bottom">
            <button id="generateIdeasBtn" class="button-generate">
                <span>‚ú®</span> generate 5 fresh ideas
            </button>
        </div>
    </div>

    <div id="scriptContainer" class="script-output" style="display: none;">
        <div class="script-label">
            script (indonesian) ¬∑ 5-6 scenes ¬∑ 10 seconds per scene = 50-60 seconds total
            <span class="scene-count-badge">üé¨ 5-6 scenes</span>
            <span class="duration-badge">‚è±Ô∏è 50-60 detik</span>
            <span class="format-badge">üìù "Selama X jam/hari" format</span>
        </div>
        <div id="scriptText" class="script-text"></div>
        
        <div class="eye-tip">
            <strong>üëÅÔ∏è EYE DETAIL INCLUDED:</strong> Every prompt includes "bright yellow glowing irises with dark pupils" - eyes visible in ALL scenes.
        </div>
        
        <div id="audioContainer" style="display: none;" class="audio-player-container">
            <div class="audio-label">
                <span>üéµ Rachel voice</span>
            </div>
            <audio id="audioPlayer" controls preload="metadata">
                <source src="" type="audio/mpeg">
                Your browser does not support audio player.
            </audio>
            <div id="audioLoading" class="loading-audio" style="display: none;">
                <div class="spinner"></div>
                <span>Generating audio...</span>
            </div>
        </div>

        <hr>
        <div class="script-label">image prompts (english ‚Äî with EYE DETAILS) ¬∑ 5-6 scenes</div>
        <div id="scenePrompts"></div>
        <div id="debugResponse" style="display: none;" class="raw-response"></div>
    </div>

    <div class="footer-credit">
        [Subject] + [Action] + [EYES: yellow irises] + [Environment] + [Lighting] + [Camera] + Render 3D ¬∑ 5-6 scenes ¬∑ 50-60s total ¬∑ "Selama X" format
    </div>
</div>

<script>
    const GROQ_URL = "https://api.groq.com/openai/v1/chat/completions";
    const GROQ_MODEL = "llama-3.3-70b-versatile";
    const ELEVENLABS_URL = "https://api.elevenlabs.io/v1";
    const RACHEL_VOICE_ID = "21m00Tcm4TlvDq8ikWAM";
    
    const STORAGE_KEYS = {
        GROQ_API_KEY: 'batasManusia_groqKey',
        ELEVENLABS_API_KEY: 'batasManusia_elevenLabsKey'
    };
    
    let generatedIdeas = [];
    let selectedIdeaIndex = null;

    const generateIdeasBtn = document.getElementById('generateIdeasBtn');
    const ideaListDiv = document.getElementById('ideaList');
    const selectedArea = document.getElementById('selectedArea');
    const selectedDisplay = document.getElementById('selectedDisplay');
    const generateScriptBtn = document.getElementById('generateScriptBtn');
    const scriptContainer = document.getElementById('scriptContainer');
    const scriptTextDiv = document.getElementById('scriptText');
    const scenePromptsDiv = document.getElementById('scenePrompts');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const elevenLabsKeyInput = document.getElementById('elevenLabsKeyInput');
    const debugResponse = document.getElementById('debugResponse');
    
    const audioContainer = document.getElementById('audioContainer');
    const audioPlayer = document.getElementById('audioPlayer');
    const audioLoading = document.getElementById('audioLoading');

    function loadSavedKeys() {
        const savedGroqKey = localStorage.getItem(STORAGE_KEYS.GROQ_API_KEY);
        if (savedGroqKey) apiKeyInput.value = savedGroqKey;
        
        const savedElevenLabsKey = localStorage.getItem(STORAGE_KEYS.ELEVENLABS_API_KEY);
        if (savedElevenLabsKey) elevenLabsKeyInput.value = savedElevenLabsKey;
    }

    function saveApiKey(key, value) {
        if (value) localStorage.setItem(key, value);
        else localStorage.removeItem(key);
    }

    function getApiKey() { return apiKeyInput.value.trim(); }
    function getElevenLabsKey() { return elevenLabsKeyInput.value.trim(); }
    function isValidApiKey(key) { return key.startsWith('gsk_') && key.length > 20; }

    apiKeyInput.addEventListener('input', () => saveApiKey(STORAGE_KEYS.GROQ_API_KEY, getApiKey()));
    elevenLabsKeyInput.addEventListener('input', () => saveApiKey(STORAGE_KEYS.ELEVENLABS_API_KEY, getElevenLabsKey()));

    async function generateAudioFile(text) {
        const apiKey = getElevenLabsKey();
        if (!apiKey) { audioContainer.style.display = 'none'; return null; }

        try {
            audioLoading.style.display = 'flex';
            audioContainer.style.display = 'block';
            audioPlayer.src = '';
            
            const response = await fetch(`${ELEVENLABS_URL}/text-to-speech/${RACHEL_VOICE_ID}`, {
                method: 'POST',
                headers: {
                    'xi-api-key': apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: text,
                    model_id: 'eleven_multilingual_v2',
                    voice_settings: { stability: 0.75, similarity_boost: 0.75, style: 0.0, speed: 1.0, use_speaker_boost: true }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail?.message || 'Failed to generate audio');
            }

            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            audioPlayer.src = audioUrl;
            audioPlayer.load();
            audioLoading.style.display = 'none';
            return audioUrl;
            
        } catch (error) {
            console.error('TTS error:', error);
            audioLoading.style.display = 'none';
            audioContainer.style.display = 'none';
            return null;
        }
    }

    generateIdeasBtn.addEventListener('click', async () => {
        const apiKey = getApiKey();
        
        if (!apiKey) {
            ideaListDiv.innerHTML = `<div class="error-message">‚ùå Enter API Key</div>`;
            return;
        }
        
        if (!isValidApiKey(apiKey)) {
            ideaListDiv.innerHTML = `<div class="error-message">‚ùå Key must start with "gsk_" + min 20 characters</div>`;
            return;
        }

        generateIdeasBtn.disabled = true;
        generateIdeasBtn.innerHTML = '‚è≥ processing...';
        ideaListDiv.innerHTML = `<div style="padding: 1.5rem; color:#666666; text-align:center;">‚è≥ finding 5 fresh ideas...</div>`;

        try {
            const ideas = await callGroqForIdeas(apiKey);
            generatedIdeas = ideas;
            renderIdeaList(ideas);
            selectedArea.style.display = 'none';
            scriptContainer.style.display = 'none';
            selectedIdeaIndex = null;
            
        } catch (e) {
            if (e.message.includes('401') || e.message.includes('Invalid API Key')) {
                ideaListDiv.innerHTML = `<div class="error-message">‚ùå Invalid API Key. <a href="https://console.groq.com/keys" target="_blank" style="color:#b91c1c;">Check here</a></div>`;
            } else {
                ideaListDiv.innerHTML = `<div class="error-message">‚ùå Failed: ${e.message}</div>`;
            }
        } finally {
            generateIdeasBtn.disabled = false;
            generateIdeasBtn.innerHTML = '‚ú® generate 5 fresh ideas';
        }
    });

    function selectIdea(index) {
        selectedIdeaIndex = index;
        const items = document.querySelectorAll('.idea-item');
        items.forEach((item, i) => {
            if (i === index) item.classList.add('selected');
            else item.classList.remove('selected');
        });
        selectedDisplay.innerText = `‚úî selected idea: ${generatedIdeas[index]}`;
        selectedArea.style.display = 'block';
        scriptContainer.style.display = 'none';
    }

    function renderIdeaList(ideas) {
        if (!ideas || ideas.length === 0) {
            ideaListDiv.innerHTML = `<div style="padding:1.5rem; text-align:center;">no ideas</div>`;
            return;
        }
        let html = '';
        ideas.forEach((idea, idx) => {
            html += `
                <div class="idea-item" data-index="${idx}">
                    <div class="idea-number">${idx+1}</div>
                    <div class="idea-content">
                        <div class="idea-title">${idea}</div>
                    </div>
                </div>
            `;
        });
        ideaListDiv.innerHTML = html;
        document.querySelectorAll('.idea-item').forEach((el) => {
            el.addEventListener('click', (e) => {
                const index = parseInt(el.dataset.index, 10);
                selectIdea(index);
            });
        });
    }

    async function copyText(button, text) {
        try {
            await navigator.clipboard.writeText(text);
            button.classList.add('copied');
            button.innerHTML = '‚úì copied';
            setTimeout(() => {
                button.classList.remove('copied');
                button.innerHTML = 'üìã copy';
            }, 2000);
        } catch (err) {
            alert('Failed to copy text');
        }
    }

    function toggleFullPrompt(showMoreEl) {
        const fullDiv = showMoreEl.parentElement.querySelector('.prompt-full');
        if (fullDiv.style.display === 'none' || !fullDiv.style.display) {
            fullDiv.style.display = 'block';
            showMoreEl.textContent = 'show less';
        } else {
            fullDiv.style.display = 'none';
            showMoreEl.textContent = 'show more';
        }
    }

    function detectFramingType(text) {
        const t = text.toLowerCase();
        
        if (t.includes("close-up") || t.includes("closeup")) return "close-up";
        if (t.includes("medium shot")) return "medium shot";
        if (t.includes("wide shot")) return "wide shot";
        if (t.includes("low-angle")) return "low-angle shot";
        if (t.includes("high-angle")) return "high-angle shot";
        return "full-body shot";
    }

    generateScriptBtn.addEventListener('click', async () => {
        if (selectedIdeaIndex === null || !generatedIdeas[selectedIdeaIndex]) return;

        const apiKey = getApiKey();
        if (!apiKey || !isValidApiKey(apiKey)) {
            alert('Invalid API Key');
            return;
        }

        const selectedIdea = generatedIdeas[selectedIdeaIndex];
        generateScriptBtn.disabled = true;
        generateScriptBtn.innerHTML = '‚è≥ writing script...';
        scriptContainer.style.display = 'block';
        scriptTextDiv.innerText = 'Waiting for Groq...';
        scenePromptsDiv.innerHTML = '';
        debugResponse.style.display = 'none';
        audioContainer.style.display = 'none';

        try {
            const result = await callGroqForScript(apiKey, selectedIdea);
            
            scriptTextDiv.innerText = result.script;

            if (getElevenLabsKey()) {
                await generateAudioFile(result.script);
            }

            let scenesHtml = '';
            result.scenes.forEach((scene, idx) => {
                const framingType = detectFramingType(scene.imagePrompt);
                
                scenesHtml += `
                    <div class="scene-prompt">
                        <div class="scene-title">‚è±Ô∏è Scene ${idx+1}: ${scene.time} ¬∑ ${framingType}</div>
                        
                        <div class="prompt-container">
                            <div class="prompt-header">
                                <span class="badge">üñºÔ∏è IMAGE PROMPT</span>
                                <button class="copy-btn" onclick="copyText(this, \`${scene.imagePrompt.replace(/`/g, '\\`')}\`)">üìã copy</button>
                            </div>
                            <div class="prompt-text">${scene.imagePrompt.substring(0, 200)}...</div>
                            <div class="prompt-full">${scene.imagePrompt}</div>
                            <span class="show-more" onclick="toggleFullPrompt(this)">show more</span>
                        </div>

                        <div class="prompt-container">
                            <div class="prompt-header">
                                <span class="badge">üé• VIDEO PROMPT</span>
                                <button class="copy-btn" onclick="copyText(this, \`${scene.videoPrompt.replace(/`/g, '\\`')}\`)">üìã copy</button>
                            </div>
                            <div class="prompt-text">${scene.videoPrompt.substring(0, 150)}...</div>
                            <div class="prompt-full">${scene.videoPrompt}</div>
                            <span class="show-more" onclick="toggleFullPrompt(this)">show more</span>
                        </div>
                    </div>
                `;
            });
            scenePromptsDiv.innerHTML = scenesHtml;
            
        } catch (e) {
            console.error('Error:', e);
            scriptTextDiv.innerText = '‚ùå FAILED: ' + e.message;
            if (e.rawResponse) {
                debugResponse.textContent = 'Raw Response:\n' + e.rawResponse;
                debugResponse.style.display = 'block';
            }
        } finally {
            generateScriptBtn.disabled = false;
            generateScriptBtn.innerHTML = 'üé¨ generate script';
        }
    });

    loadSavedKeys();

    async function callGroqForIdeas(apiKey) {
        const prompt = `Create 5 short video titles in QUESTION format about human body limits in Indonesian language.

MANDATORY FORMAT: "Berapa [TIME UNIT] [ACTIVITY] Sampai [ORGAN/BODY PART] [EXTREME VERB]?"

RULES:
1. Time units: Jam (Hours), Menit (Minutes), Detik (Seconds), Hari (Days), Potong (Pieces), Botol (Bottles), Batang (Sticks), Kali (Times)
2. Activities: Begadang (Staying up late), Main Game (Gaming), Pakai Headset (Using headset), Minum Kopi (Drinking coffee), Makan Pedas (Eating spicy food), Nonton Film (Watching movies), Jogging, Tahan Napas (Holding breath), Tidak Mandi (Not bathing), Tatap Matahari (Staring at sun), Main HP (Using phone), Duduk (Sitting), Makan Pizza (Eating pizza), Minum Energi Drink (Drinking energy drinks), Merokok (Smoking)
3. Organs: Otak (Brain), Paru-paru (Lungs), Jantung (Heart), Mata (Eyes), Telinga (Ears), Lambung (Stomach), Kulit (Skin), Kaki (Feet), Leher (Neck), Ginjal (Kidneys)
4. Extreme verbs: ERROR, MENJERIT (SCREAMING), JADI BATU (TURN TO STONE), BUTA (BLIND), MELELEH (MELTING), MELEDAK (EXPLODING), RUSAK (BROKEN), MATI RASA (NUMB), BEKU (FROZEN), PATAH (FRACTURED), BOCOR (LEAKING), HITAM (BLACK), LUMPUH (PARALYZED), HANCUR (DESTROYED)

Write numbers 1-5 only. Titles only in Indonesian. Create fresh variations.

Example:
- Berapa Jam Begadang Sampai Otakmu ERROR?
- Berapa Batang Rokok Sampai Paru-Parumu HANCUR?`;

        const body = {
            model: GROQ_MODEL,
            messages: [{ role: "user", content: prompt }],
            temperature: 1.0,
            max_tokens: 800
        };

        try {
            const resp = await fetch(GROQ_URL, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!resp.ok) {
                const errData = await resp.json().catch(() => ({}));
                throw new Error(errData.error?.message || `Error ${resp.status}`);
            }

            const data = await resp.json();
            const content = data.choices[0]?.message?.content || "";
            const lines = content.split('\n').filter(l => l.trim().match(/^\d+\./));
            const ideas = [];
            
            for (let line of lines) {
                const withoutNumber = line.replace(/^\d+\.\s*/, '').trim();
                if (withoutNumber) ideas.push(withoutNumber);
            }
            
            if (ideas.length === 0) throw new Error('No ideas generated');
            return ideas.slice(0, 5);
            
        } catch (error) {
            console.error('Error:', error);
            throw error;
        }
    }

    async function callGroqForScript(apiKey, ideaTitle) {
        const systemPrompt = `You are a video scriptwriter for a viral YouTube Shorts channel. 

Write a script in INDONESIAN language based on this title: "${ideaTitle}"

WRITING STYLE: Calm, clinical but conversational, second-person ("kamu" - "you"), short sentences.

**CRITICAL REQUIREMENTS - MUST FOLLOW EXACTLY:**

## PART 1: SCRIPT STRUCTURE (5-6 SCENES, 10 SECONDS PER SCENE)

The script MUST be divided into EXACTLY 5-6 scenes, EACH scene lasting 10 seconds when spoken.
This means the ENTIRE script should be 50-60 seconds total.

**IMPORTANT TIMELINE FORMAT RULES:**
- MUST use "Selama X [unit waktu]" format (NOT "Pada jam pertama" or "Pada hari pertama")
- Examples of CORRECT format:
  * "Selama 1 jam, ..."
  * "Selama 6 jam, ..."
  * "Selama 12 jam, ..."
  * "Selama 1 hari, ..."
  * "Selama 3 hari, ..."
  * "Selama 1 tahun, ..."
  * "Selama 5 tahun, ..."

- Examples of INCORRECT format (DO NOT USE):
  * "Pada jam pertama..." ‚ùå
  * "Di hari pertama..." ‚ùå
  * "Memasuki jam ke-5..." ‚ùå

**SCRIPT STRUCTURE:**
- Scene 1: Title + HOOK sentence (one intriguing sentence)
- Scene 2-5/6: Timeline using "Selama X [unit waktu]" format
- Final Scene: Catastrophic failure + abrupt ending

**SCENE BREAKDOWN EXAMPLE (for "Berapa Jam Begadang Sampai Otakmu ERROR?"):**

Scene 1 (10 seconds): 
"Berapa Jam Begadang Sampai Otakmu ERROR? Tanpa kamu sadari, otakmu mulai kehilangan kendali."

Scene 2 (10 seconds): 
"Selama 12 jam, kamu masih merasa segar. Adrenalin bekerja. Otakmu masih fokus."

Scene 3 (10 seconds): 
"Selama 24 jam, konsentrasimu mulai buyar. Dunia terasa agak kabur. Otakmu mulai kelelahan."

Scene 4 (10 seconds): 
"Selama 36 jam, otakmu mulai menciptakan ilusi. Kamu melihat bayangan di ujung mata."

Scene 5 (10 seconds): 
"Selama 48 jam, otakmu ERROR total. Kamu tidak bisa lagi membedakan mana nyata dan mana tidak."

Scene 6 (10 seconds): 
"Pada jam ke-72, tubuhmu roboh. Otakmu berhenti merespon. Gelap."

**SCENE BREAKDOWN EXAMPLE (for "Berapa Batang Rokok Sampai Paru-Parumu HANCUR?"):**

Scene 1 (10 seconds): 
"Berapa Batang Rokok Sampai Paru-Parumu HANCUR? Tanpa kamu sadari, paru-parumu sedang mengalami kerusakan yang tidak dapat diperbaiki."

Scene 2 (10 seconds): 
"Selama 1 tahun, kamu masih merasa sehat. Paru-parumu masih dapat bernapas dengan baik."

Scene 3 (10 seconds): 
"Selama 5 tahun, kamu mulai merasakan sesak napas. Paru-parumu mulai meradang."

Scene 4 (10 seconds): 
"Selama 10 tahun, fibrosis mulai terbentuk. Setiap tarikan napas terasa seperti menusuk."

Scene 5 (10 seconds): 
"Selama 15 tahun, paru-parumu mulai menghitam. Batuk kronis tidak pernah berhenti."

Scene 6 (10 seconds): 
"Selama 20 tahun, paru-parumu HANCUR total. Kamu roboh. Napas terakhir."

**TOTAL: 6 scenes = 60 seconds**

## PART 2: SCENE BREAKDOWN FOR VISUALS

After writing the script, create EXACTLY 5-6 scene breakdowns (SAME NUMBER as script scenes).
For EACH scene, use this EXACT formula for image prompts:

**PROMPT FORMULA: [SUBJECT] + [ACTION/POSE] + [EYE DESCRIPTION] + [ENVIRONMENT CONTEXT] + [PROPERTY DETAILS] + [LIGHTING TYPE] + [CAMERA ANGLE] + [VISUAL EFFECTS] + [RENDER STYLE]**

**CRITICAL RULES FOR EYES (MUST FOLLOW):**
- The skeleton character MUST have visible eyes in EVERY scene
- Base eye description: "bright yellow glowing irises with dark pupils, visible through transparent skull"
- Eye condition MUST change according to scene progression:

| Scene Stage | Eye Description |
|-------------|-----------------|
| Scene 1 (Opening) | "bright yellow glowing irises with dark pupils, eyes clear and alert, glowing warmly" |
| Scene 2 (Early) | "bright yellow irises with dark pupils, eyes showing first signs of strain, glow still bright" |
| Scene 3 (Mid) | "yellow irises with dark pupils, eyes visibly strained, glow beginning to dim" |
| Scene 4 (Mid-Late) | "yellow irises flickering and dimming, pupils slightly irregular, glow fading, dark circles forming" |
| Scene 5 (Late) | "yellow irises dim and flickering, pupils irregular, glow almost gone, deep dark circles" |
| Scene 6 (Final) | "eyes completely dark and lifeless, no yellow glow remaining, milky film covering the irises" |

**EXAMPLE WITH EYES INCLUDED (begadang theme - 6 scenes):**

Scene 1 (Opening):
"Place the skeleton character sitting at a computer desk late at night, hands on keyboard, monitor glowing, with **bright yellow glowing irises with dark pupils visible through transparent skull, eyes clear and alert, glowing warmly**, a fresh cup of coffee on the desk. Blue monitor light creates cool rim lighting. Use a medium wide shot showing the focused posture. Add subtle screen flicker. Rendered in clean cinematic 3D, highly detailed."

Scene 2 (12 jam):
"Place the skeleton character still at the computer, now with an empty coffee cup, slightly slumped posture, with **bright yellow irises with dark pupils, eyes showing first signs of strain, glow still bright**. Monitor shows 2AM. Dim room with monitor as primary light. Use a medium shot. Add eye strain effects. Rendered in clean cinematic 3D, highly detailed."

Scene 3 (24 jam):
"Place the skeleton character hunched forward, one hand rubbing its temple, the other still on mouse, multiple empty coffee cups, with **yellow irises with dark pupils, eyes visibly strained, glow beginning to dim**. Monitor shows 6AM, dawn light faintly through window. Use a close-up shot on face. Add dark circles beginning to form. Rendered in clean cinematic 3D, highly detailed."

Scene 4 (36 jam):
"Place the skeleton character slumped in chair, head tilted back, eyes half-closed but still open, with **yellow irises flickering and dimming, pupils slightly irregular, glow fading, dark circles forming**. Harsh morning light creates deep shadows. Use a close-up shot. Add eye twitching effects. Rendered in clean cinematic 3D, highly detailed."

Scene 5 (48 jam):
"Place the skeleton character collapsed forward onto desk, face near keyboard, eyes still open staring blankly at screen, with **yellow irises dim and flickering, pupils irregular, glow almost gone, deep dark circles**. Monitor screen flickering with static. Use an overhead shot. Add disorientation effects. Rendered in clean cinematic 3D, highly detailed."

Scene 6 (72 jam - Final):
"Place the skeleton character fallen from chair onto floor, limbs sprawled, eyes wide open but lifeless, with **eyes completely dark and lifeless, no yellow glow remaining, milky film covering the irises, staring blankly at ceiling**. Morning light streams through window, creating harsh shadows on the collapsed figure. Use a dramatic low-angle shot. Add finality atmosphere. Rendered in clean cinematic 3D, highly detailed."

**CRITICAL RULES SUMMARY:**
- Script MUST have EXACTLY 5-6 scenes
- EACH scene MUST be ~10 seconds when spoken (total 50-60 seconds)
- **MUST use "Selama X [unit]" format for timeline scenes (NOT "Pada jam pertama")**
- Scene 1 MUST have title + HOOK sentence
- Create EXACTLY 5-6 image prompts (one per scene)
- Scene 1 MUST show the ACTIVITY from the title
- ALL scenes MUST show progression of that activity
- The character MUST be doing the activity in EVERY scene
- Use "Place the skeleton character" at the START of EVERY image prompt
- **EVERY image prompt MUST include eye description that progresses through the stages**
- End EVERY image prompt with "Rendered in clean cinematic 3D, highly detailed."
- ALL prompts must be in ENGLISH

Format output:
===SCRIPT===
Scene 1 (10 seconds): [Title + HOOK]
Scene 2 (10 seconds): [Selama X unit...]
Scene 3 (10 seconds): [Selama X unit...]
Scene 4 (10 seconds): [Selama X unit...]
Scene 5 (10 seconds): [Selama X unit...]
Scene 6 (10 seconds): [Selama X unit... + catastrophic ending] (optional - use 5 or 6 scenes)

===SCENES===
Scene 1:
Time: [from script, e.g., "Opening" or "0 jam"]
Environment: [location in English]
Image prompt: [Place the skeleton character... with eye description for Scene 1... Rendered in clean cinematic 3D, highly detailed.]
Video prompt: [subtle movement description in English]

Scene 2:
Time: [from script, e.g., "12 jam"]
Environment: [location in English]
Image prompt: [Place the skeleton character... with eye description for Scene 2... Rendered in clean cinematic 3D, highly detailed.]
Video prompt: [subtle movement description in English]

(continue for all 5-6 scenes)`;

        const body = {
            model: GROQ_MODEL,
            messages: [{ role: "user", content: systemPrompt }],
            temperature: 0.8,
            max_tokens: 12000
        };

        try {
            const resp = await fetch(GROQ_URL, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!resp.ok) {
                const errData = await resp.json().catch(() => ({}));
                throw new Error(errData.error?.message || `Error ${resp.status}`);
            }

            const data = await resp.json();
            const fullContent = data.choices[0]?.message?.content || "";
            const rawResponse = fullContent;

            let scriptPart = "";
            let scenesPart = "";
            
            if (fullContent.includes("===SCRIPT===") && fullContent.includes("===SCENES===")) {
                const parts = fullContent.split("===SCENES===");
                scriptPart = parts[0].replace("===SCRIPT===", "").trim();
                scenesPart = parts[1] || "";
            } else {
                const error = new Error('Response format incorrect. Expected ===SCRIPT=== and ===SCENES=== markers.');
                error.rawResponse = rawResponse;
                throw error;
            }

            const sceneRegex = /Scene\s*\d+.*?:\s*Time:\s*(.*?)\s*Environment:\s*(.*?)\s*Image prompt:\s*(.*?)\s*Video prompt:\s*(.*?)(?=\n\s*Scene|\n*$)/gis;
            const scenes = [];
            let match;
            
            while ((match = sceneRegex.exec(scenesPart)) !== null) {
                scenes.push({
                    time: match[1].trim(),
                    environment: match[2].trim(),
                    imagePrompt: match[3].trim(),
                    videoPrompt: match[4].trim(),
                    narration: scriptPart
                });
            }

            if (scenes.length === 0) {
                const error = new Error('No scenes found in response');
                error.rawResponse = rawResponse;
                throw error;
            }

            // Validate scene count (should be 5-6)
            if (scenes.length < 5 || scenes.length > 6) {
                console.warn(`Warning: Expected 5-6 scenes but got ${scenes.length}`);
            }

            return { script: scriptPart, scenes: scenes };
            
        } catch (error) {
            console.error('Error:', error);
            throw error;
        }
    }

    window.copyText = copyText;
    window.toggleFullPrompt = toggleFullPrompt;
</script>
</body>
</html>
