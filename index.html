<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>batas ¬∑ manusia ‚Äî generator ide video</title>
    <!-- Plus Jakarta Sans untuk logo dan judul -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Inter untuk lainnya -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300..700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", sans-serif;
            background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 1.8rem;
            color: #333333;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Logo di tengah dengan Plus Jakarta Sans - ungu neon */
        .logo-container {
            text-align: center;
            margin: 0.5rem 0 2.5rem 0;
        }
        .logo-container h1 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 2.8rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #a855f7, #d946ef);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            text-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
        }
        .logo-container .sub {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 400;
            color: #666666;
            font-size: 1rem;
            margin-top: 0.25rem;
            letter-spacing: 0.3px;
            text-shadow: 0 0 10px rgba(168, 85, 247, 0.2);
        }

        /* Card dengan efek glass putih */
        .card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border-radius: 2.5rem;
            padding: 2.2rem 2.2rem;
            box-shadow: 0 25px 50px -12px rgba(168, 85, 247, 0.2), 0 4px 18px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(168, 85, 247, 0.2);
            transition: all 0.2s ease;
        }

        /* Input API Key */
        .api-key-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 1rem 1.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.8rem;
            border: 1px solid rgba(168, 85, 247, 0.3);
            box-shadow: 0 10px 15px -3px rgba(168, 85, 247, 0.1);
        }
        .api-key-label {
            font-weight: 600;
            color: #a855f7;
            min-width: 90px;
            font-size: 0.95rem;
        }
        .api-key-input {
            flex: 1;
            min-width: 220px;
            padding: 0.7rem 1.3rem;
            border-radius: 3rem;
            border: 2px solid #e5e7eb;
            font-family: 'Inter', monospace;
            font-size: 0.9rem;
            background: white;
            color: #333333;
            outline: none;
            transition: 0.15s;
        }
        .api-key-input:focus {
            border-color: #a855f7;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
        }
        .api-key-hint {
            font-size: 0.8rem;
            color: #666666;
            width: 100%;
            margin-top: 0.2rem;
        }

        /* Version selector */
        .version-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 1rem 1.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.8rem;
            border: 1px solid rgba(168, 85, 247, 0.3);
            box-shadow: 0 10px 15px -3px rgba(168, 85, 247, 0.1);
        }
        .version-label {
            font-weight: 600;
            color: #a855f7;
            min-width: 90px;
            font-size: 0.95rem;
        }
        .version-select {
            flex: 1;
            min-width: 220px;
            padding: 0.7rem 1.3rem;
            border-radius: 3rem;
            border: 2px solid #e5e7eb;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            background: white;
            color: #333333;
            outline: none;
            transition: 0.15s;
            cursor: pointer;
        }
        .version-select:focus {
            border-color: #a855f7;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
        }
        .version-description {
            font-size: 0.8rem;
            color: #666666;
            width: 100%;
            margin-top: 0.2rem;
            font-style: italic;
        }

        /* Tombol gradasi ungu neon */
        .button-generate {
            background: linear-gradient(135deg, #a855f7, #d946ef);
            border: none;
            padding: 0.8rem 2.2rem;
            border-radius: 3rem;
            font-weight: 600;
            font-size: 1rem;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            cursor: pointer;
            box-shadow: 0 10px 25px -5px rgba(168, 85, 247, 0.3);
            transition: 0.2s;
            letter-spacing: 0.01em;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .button-generate:hover {
            background: linear-gradient(135deg, #9333ea, #c026d3);
            box-shadow: 0 15px 30px -5px rgba(168, 85, 247, 0.4);
            transform: scale(1.02);
        }

        .button-generate:disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(0.3);
        }

        .button-secondary {
            background: white;
            border: 1.5px solid #a855f7;
            padding: 0.5rem 1.5rem;
            border-radius: 3rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: #a855f7;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.1);
            transition: 0.1s;
        }
        .button-secondary:hover {
            background: #a855f7;
            color: white;
            border-color: #d946ef;
        }

        .idea-grid {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin: 1.5rem 0 1.5rem;
        }

        .idea-item {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 0.9rem 1.5rem;
            border-left: 8px solid #a855f7;
            box-shadow: 0 10px 15px -3px rgba(168, 85, 247, 0.1);
            transition: 0.15s ease;
            cursor: pointer;
            border: 1px solid rgba(168, 85, 247, 0.2);
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .idea-item:hover {
            background: white;
            border-left-width: 12px;
            border-left-color: #d946ef;
            box-shadow: 0 15px 20px -5px rgba(168, 85, 247, 0.2);
        }

        .idea-item.selected {
            background: white;
            border-left-color: #d946ef;
            border: 2px solid #a855f7;
            box-shadow: 0 8px 25px rgba(168, 85, 247, 0.2);
        }

        .idea-number {
            width: 2.3rem;
            height: 2.3rem;
            background: linear-gradient(135deg, #a855f7, #d946ef);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            font-size: 0.9rem;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.3);
        }

        .idea-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333333;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .script-output {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(16px);
            border-radius: 2.5rem;
            padding: 1.8rem;
            border: 1px solid rgba(168, 85, 247, 0.2);
            box-shadow: 0 20px 40px -15px rgba(168, 85, 247, 0.15);
            margin-top: 2rem;
        }

        .script-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #a855f7;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .script-text {
            font-size: 1.1rem;
            line-height: 1.6;
            white-space: pre-wrap;
            color: #333333;
            font-weight: 400;
            border-left: 4px solid #a855f7;
            padding-left: 1.3rem;
        }

        .scene-prompt {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 1.3rem;
            margin: 1.5rem 0 0.5rem;
            border: 1px dashed #a855f7;
        }

        .scene-title {
            font-weight: 700;
            color: #a855f7;
            margin-bottom: 0.8rem;
            font-size: 1.2rem;
        }

        .prompt-container {
            background: white;
            border-radius: 1.3rem;
            padding: 0.9rem 1.2rem;
            margin-bottom: 0.8rem;
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .badge {
            background: linear-gradient(135deg, #a855f7, #d946ef);
            border-radius: 3rem;
            padding: 0.2rem 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            display: inline-block;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.2);
        }

        .copy-btn {
            background: none;
            border: 1px solid #a855f7;
            color: #a855f7;
            padding: 0.2rem 1rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.1s;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .copy-btn:hover {
            background: #a855f7;
            color: white;
        }

        .copy-btn.copied {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .prompt-text {
            font-size: 0.9rem;
            color: #333333;
            line-height: 1.5;
            word-break: break-word;
        }

        .prompt-full {
            display: none;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #a855f7;
        }

        .show-more {
            color: #a855f7;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 0.25rem;
            display: inline-block;
        }

        hr {
            border: 0.5px solid rgba(168, 85, 247, 0.2);
            margin: 1.2rem 0;
        }

        .action-bottom {
            display: flex;
            justify-content: center;
            margin: 1rem 0 0.2rem;
        }

        .selected-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            border-radius: 4rem;
            padding: 0.5rem 1.5rem;
            margin: 1rem 0 0.5rem;
            border: 1px solid #a855f7;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.1);
        }

        #selectedDisplay {
            color: #a855f7;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .footer-credit {
            text-align: center;
            color: #a855f7;
            margin-top: 2rem;
            font-size: 0.8rem;
        }

        .error-message {
            background: #fee2e2;
            color: #b91c1c;
            padding: 0.8rem 1.5rem;
            border-radius: 3rem;
            margin: 1rem 0;
            border: 1px solid #ef4444;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .raw-response {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: monospace;
            font-size: 0.8rem;
            padding: 1rem;
            border-radius: 1rem;
            margin-top: 1rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow: auto;
        }

        .get-key-link {
            color: #a855f7;
            font-weight: 600;
            text-decoration: none;
            border-bottom: 1px dashed #a855f7;
        }
        .get-key-link:hover {
            color: #d946ef;
        }

        .audio-player-container {
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 2rem;
            border: 1px solid rgba(168, 85, 247, 0.3);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .audio-player-container audio {
            width: 100%;
            height: 40px;
            border-radius: 2rem;
        }

        .audio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #a855f7;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .voice-badge {
            background: rgba(168, 85, 247, 0.15);
            border: 1px solid #a855f7;
            color: #a855f7;
            padding: 0.2rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            margin-left: 0.5rem;
        }

        .loading-audio {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #a855f7;
            font-size: 0.9rem;
            padding: 0.5rem;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(168, 85, 247, 0.3);
            border-top-color: #a855f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, #a855f7, #d946ef);
            color: white;
            padding: 0.2rem 1rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="logo-container">
        <h1>batas ¬∑ manusia</h1>
        <div class="sub">kegagalan biologis dalam visual sunyi</div>
    </div>

    <div class="card">
        <div class="api-key-container">
            <span class="api-key-label">üîë Groq Key</span>
            <input type="password" id="apiKeyInput" class="api-key-input" placeholder="gsk_...">
            <div class="api-key-hint">
                <a href="https://console.groq.com/keys" target="_blank" class="get-key-link">Dapatkan key</a>
            </div>
        </div>

        <div class="api-key-container">
            <span class="api-key-label">üé§ ElevenLabs Key</span>
            <input type="password" id="elevenLabsKeyInput" class="api-key-input" placeholder="elevenlabs_...">
            <div class="api-key-hint">
                <a href="https://elevenlabs.io/app/settings/api-keys" target="_blank" class="get-key-link">Dapatkan key</a> (opsional)
                <span class="voice-badge">‚ú® Rachel</span>
            </div>
        </div>

        <!-- VERSION SELECTOR - Pilih gaya ide yang diinginkan -->
        <div class="version-container">
            <span class="version-label">üé≠ Versi Ide</span>
            <select id="versionSelect" class="version-select">
                <option value="1">üåø Versi 1: Relatable (realistis)</option>
                <option value="2">üî• Versi 2: Ekstrem (dramatis)</option>
                <option value="3">üåÄ Versi 3: Surreal (absurd)</option>
                <option value="4">üé≠ Versi 4: Filosofis absurd</option>
                <option value="5">üé™ Versi 5: Random murni</option>
                <option value="6">üß™ Versi 6: Aktivitas aneh</option>
                <option value="7">üìä Versi 7: Ilmiah palsu</option>
                <option value="8">üé† Versi 8: Keseharian absurd</option>
                <option value="9">ü™Ñ Versi 9: Fantasi</option>
                <option value="10">üåå Versi 10: Digital</option>
            </select>
            <div class="version-description" id="versionDescription">
                üåø Aktivitas sehari-hari yang realistis (begadang, main game, kopi)
            </div>
        </div>

        <div id="ideaList" class="idea-grid">
            <div style="text-align: center; color: #666666; padding: 1.5rem; font-style: italic; font-size: 0.95rem;">
                Masukkan API Key, pilih versi, lalu generate
            </div>
        </div>

        <div id="selectedArea" style="display: none;">
            <div class="selected-bar">
                <span id="selectedDisplay">‚úî ide terpilih: </span>
                <button id="generateScriptBtn" class="button-secondary">üé¨ buat naskah</button>
            </div>
        </div>

        <div class="action-bottom">
            <button id="generateIdeasBtn" class="button-generate">
                <span>‚ú®</span> generate 5 ide fresh
            </button>
        </div>
    </div>

    <div id="scriptContainer" class="script-output" style="display: none;">
        <div class="script-label">naskah (bahasa indonesia) ¬∑ 45‚Äì70 detik</div>
        <div id="scriptText" class="script-text"></div>
        
        <div id="audioContainer" style="display: none;" class="audio-player-container">
            <div class="audio-label">
                <span>üéµ Suara Rachel</span>
            </div>
            <audio id="audioPlayer" controls preload="metadata">
                <source src="" type="audio/mpeg">
                Browser tidak mendukung audio player.
            </audio>
            <div id="audioLoading" class="loading-audio" style="display: none;">
                <div class="spinner"></div>
                <span>Menghasilkan suara...</span>
            </div>
        </div>

        <hr>
        <div class="script-label">image prompts (english ‚Äî format rumus)</div>
        <div id="scenePrompts"></div>
        <div id="debugResponse" style="display: none;" class="raw-response"></div>
    </div>

    <div class="footer-credit">
        [Subjek] + [Aksi] + [Lingkungan] + [Cahaya] + [Sudut Kamera] + [VFX] + Render 3D
    </div>
</div>

<script>
    const GROQ_URL = "https://api.groq.com/openai/v1/chat/completions";
    const GROQ_MODEL = "llama-3.3-70b-versatile";
    const ELEVENLABS_URL = "https://api.elevenlabs.io/v1";
    const RACHEL_VOICE_ID = "21m00Tcm4TlvDq8ikWAM";
    
    const STORAGE_KEYS = {
        GROQ_API_KEY: 'batasManusia_groqKey',
        ELEVENLABS_API_KEY: 'batasManusia_elevenLabsKey'
    };
    
    let generatedIdeas = [];
    let selectedIdeaIndex = null;

    const generateIdeasBtn = document.getElementById('generateIdeasBtn');
    const ideaListDiv = document.getElementById('ideaList');
    const selectedArea = document.getElementById('selectedArea');
    const selectedDisplay = document.getElementById('selectedDisplay');
    const generateScriptBtn = document.getElementById('generateScriptBtn');
    const scriptContainer = document.getElementById('scriptContainer');
    const scriptTextDiv = document.getElementById('scriptText');
    const scenePromptsDiv = document.getElementById('scenePrompts');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const elevenLabsKeyInput = document.getElementById('elevenLabsKeyInput');
    const debugResponse = document.getElementById('debugResponse');
    const versionSelect = document.getElementById('versionSelect');
    const versionDescription = document.getElementById('versionDescription');
    
    const audioContainer = document.getElementById('audioContainer');
    const audioPlayer = document.getElementById('audioPlayer');
    const audioLoading = document.getElementById('audioLoading');

    // Update description when version changes
    versionSelect.addEventListener('change', function() {
        const descriptions = {
            '1': 'üåø Aktivitas sehari-hari yang realistis (begadang, main game, kopi)',
            '2': 'üî• Versi paling dramatis dan ekstrem (meledak, hancur, menjerit)',
            '3': 'üåÄ Aktivitas surreal dan tidak masuk akal (menatap kulkas kosong, ngomong sama tembok)',
            '4': 'üé≠ Filosofis absurd (mencari arti hidup, overthinking, nahan uang)',
            '5': 'üé™ Kombinasi paling random dan tidak terduga',
            '6': 'üß™ Aktivitas aneh yang jarang terpikirkan (ngupas bawang, main petak umpet)',
            '7': 'üìä Gaya ilmiah palsu dengan satuan absurd (milidetik, desibel, volt)',
            '8': 'üé† Aktivitas keseharian yang dibikin absurd (nyari remote, bilang "bentar")',
            '9': 'ü™Ñ Dunia fantasi dan imajinasi (terbang di mimpi, ramuan cinta)',
            '10': 'üåå Tema digital dan teknologi (loading screen, update status, QR code)'
        };
        versionDescription.textContent = descriptions[versionSelect.value];
    });

    function loadSavedKeys() {
        const savedGroqKey = localStorage.getItem(STORAGE_KEYS.GROQ_API_KEY);
        if (savedGroqKey) apiKeyInput.value = savedGroqKey;
        
        const savedElevenLabsKey = localStorage.getItem(STORAGE_KEYS.ELEVENLABS_API_KEY);
        if (savedElevenLabsKey) elevenLabsKeyInput.value = savedElevenLabsKey;
    }

    function saveApiKey(key, value) {
        if (value) localStorage.setItem(key, value);
        else localStorage.removeItem(key);
    }

    function getApiKey() { return apiKeyInput.value.trim(); }
    function getElevenLabsKey() { return elevenLabsKeyInput.value.trim(); }
    function isValidApiKey(key) { return key.startsWith('gsk_') && key.length > 20; }

    apiKeyInput.addEventListener('input', () => saveApiKey(STORAGE_KEYS.GROQ_API_KEY, getApiKey()));
    elevenLabsKeyInput.addEventListener('input', () => saveApiKey(STORAGE_KEYS.ELEVENLABS_API_KEY, getElevenLabsKey()));

    async function generateAudioFile(text) {
        const apiKey = getElevenLabsKey();
        if (!apiKey) { audioContainer.style.display = 'none'; return null; }

        try {
            audioLoading.style.display = 'flex';
            audioContainer.style.display = 'block';
            audioPlayer.src = '';
            
            const response = await fetch(`${ELEVENLABS_URL}/text-to-speech/${RACHEL_VOICE_ID}`, {
                method: 'POST',
                headers: {
                    'xi-api-key': apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: text,
                    model_id: 'eleven_multilingual_v2',
                    voice_settings: { stability: 0.75, similarity_boost: 0.75, style: 0.0, speed: 1.0, use_speaker_boost: true }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail?.message || 'Gagal generate suara');
            }

            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            audioPlayer.src = audioUrl;
            audioPlayer.load();
            audioLoading.style.display = 'none';
            return audioUrl;
            
        } catch (error) {
            console.error('TTS error:', error);
            audioLoading.style.display = 'none';
            audioContainer.style.display = 'none';
            return null;
        }
    }

    generateIdeasBtn.addEventListener('click', async () => {
        const apiKey = getApiKey();
        
        if (!apiKey) {
            ideaListDiv.innerHTML = `<div class="error-message">‚ùå Masukkan API Key</div>`;
            return;
        }
        
        if (!isValidApiKey(apiKey)) {
            ideaListDiv.innerHTML = `<div class="error-message">‚ùå Format key harus "gsk_" + minimal 20 karakter</div>`;
            return;
        }

        generateIdeasBtn.disabled = true;
        generateIdeasBtn.innerHTML = '‚è≥ memproses...';
        ideaListDiv.innerHTML = `<div style="padding: 1.5rem; color:#666666; text-align:center;">‚è≥ mencari 5 ide fresh versi ${versionSelect.value}...</div>`;

        try {
            const ideas = await callGroqForIdeas(apiKey, versionSelect.value);
            generatedIdeas = ideas;
            renderIdeaList(ideas);
            selectedArea.style.display = 'none';
            scriptContainer.style.display = 'none';
            selectedIdeaIndex = null;
            
        } catch (e) {
            if (e.message.includes('401') || e.message.includes('Invalid API Key')) {
                ideaListDiv.innerHTML = `<div class="error-message">‚ùå API Key tidak valid. <a href="https://console.groq.com/keys" target="_blank" style="color:#b91c1c;">Cek di sini</a></div>`;
            } else {
                ideaListDiv.innerHTML = `<div class="error-message">‚ùå Gagal: ${e.message}</div>`;
            }
        } finally {
            generateIdeasBtn.disabled = false;
            generateIdeasBtn.innerHTML = '‚ú® generate 5 ide fresh';
        }
    });

    function selectIdea(index) {
        selectedIdeaIndex = index;
        const items = document.querySelectorAll('.idea-item');
        items.forEach((item, i) => {
            if (i === index) item.classList.add('selected');
            else item.classList.remove('selected');
        });
        selectedDisplay.innerText = `‚úî ide terpilih: ${generatedIdeas[index]}`;
        selectedArea.style.display = 'block';
        scriptContainer.style.display = 'none';
    }

    function renderIdeaList(ideas) {
        if (!ideas || ideas.length === 0) {
            ideaListDiv.innerHTML = `<div style="padding:1.5rem; text-align:center;">tidak ada ide</div>`;
            return;
        }
        let html = '';
        ideas.forEach((idea, idx) => {
            html += `
                <div class="idea-item" data-index="${idx}">
                    <div class="idea-number">${idx+1}</div>
                    <div class="idea-content">
                        <div class="idea-title">${idea}</div>
                    </div>
                </div>
            `;
        });
        ideaListDiv.innerHTML = html;
        document.querySelectorAll('.idea-item').forEach((el) => {
            el.addEventListener('click', (e) => {
                const index = parseInt(el.dataset.index, 10);
                selectIdea(index);
            });
        });
    }

    async function copyText(button, text) {
        try {
            await navigator.clipboard.writeText(text);
            button.classList.add('copied');
            button.innerHTML = '‚úì copied';
            setTimeout(() => {
                button.classList.remove('copied');
                button.innerHTML = 'üìã copy';
            }, 2000);
        } catch (err) {
            alert('Gagal menyalin teks');
        }
    }

    function toggleFullPrompt(showMoreEl) {
        const fullDiv = showMoreEl.parentElement.querySelector('.prompt-full');
        if (fullDiv.style.display === 'none' || !fullDiv.style.display) {
            fullDiv.style.display = 'block';
            showMoreEl.textContent = 'sembunyikan';
        } else {
            fullDiv.style.display = 'none';
            showMoreEl.textContent = 'lihat selengkapnya';
        }
    }

    function detectFramingType(text) {
        const t = text.toLowerCase();
        
        if (t.includes("close-up") || t.includes("closeup")) return "closeup";
        if (t.includes("medium shot")) return "medium";
        if (t.includes("wide shot")) return "wide";
        return "full-body";
    }

    generateScriptBtn.addEventListener('click', async () => {
        if (selectedIdeaIndex === null || !generatedIdeas[selectedIdeaIndex]) return;

        const apiKey = getApiKey();
        if (!apiKey || !isValidApiKey(apiKey)) {
            alert('API Key tidak valid');
            return;
        }

        const selectedIdea = generatedIdeas[selectedIdeaIndex];
        generateScriptBtn.disabled = true;
        generateScriptBtn.innerHTML = '‚è≥ menyusun naskah...';
        scriptContainer.style.display = 'block';
        scriptTextDiv.innerText = 'Menunggu Groq...';
        scenePromptsDiv.innerHTML = '';
        debugResponse.style.display = 'none';
        audioContainer.style.display = 'none';

        try {
            const result = await callGroqForScript(apiKey, selectedIdea);
            
            scriptTextDiv.innerText = result.script;

            if (getElevenLabsKey()) {
                await generateAudioFile(result.script);
            }

            let scenesHtml = '';
            result.scenes.forEach((scene, idx) => {
                const framingType = detectFramingType(scene.imagePrompt);
                
                scenesHtml += `
                    <div class="scene-prompt">
                        <div class="scene-title">‚è±Ô∏è ${scene.time} ¬∑ ${framingType}</div>
                        
                        <div class="prompt-container">
                            <div class="prompt-header">
                                <span class="badge">üñºÔ∏è IMAGE PROMPT</span>
                                <button class="copy-btn" onclick="copyText(this, \`${scene.imagePrompt.replace(/`/g, '\\`')}\`)">üìã copy</button>
                            </div>
                            <div class="prompt-text">${scene.imagePrompt.substring(0, 200)}...</div>
                            <div class="prompt-full">${scene.imagePrompt}</div>
                            <span class="show-more" onclick="toggleFullPrompt(this)">lihat selengkapnya</span>
                        </div>

                        <div class="prompt-container">
                            <div class="prompt-header">
                                <span class="badge">üé• VIDEO PROMPT</span>
                                <button class="copy-btn" onclick="copyText(this, \`${scene.videoPrompt.replace(/`/g, '\\`')}\`)">üìã copy</button>
                            </div>
                            <div class="prompt-text">${scene.videoPrompt.substring(0, 150)}...</div>
                            <div class="prompt-full">${scene.videoPrompt}</div>
                            <span class="show-more" onclick="toggleFullPrompt(this)">lihat selengkapnya</span>
                        </div>
                    </div>
                `;
            });
            scenePromptsDiv.innerHTML = scenesHtml;
            
        } catch (e) {
            console.error('Error:', e);
            scriptTextDiv.innerText = '‚ùå GAGAL: ' + e.message;
            if (e.rawResponse) {
                debugResponse.textContent = 'Raw Response:\n' + e.rawResponse;
                debugResponse.style.display = 'block';
            }
        } finally {
            generateScriptBtn.disabled = false;
            generateScriptBtn.innerHTML = 'üé¨ buat naskah';
        }
    });

    loadSavedKeys();

    async function callGroqForIdeas(apiKey, version) {
        // Base prompt structure
        let basePrompt = `Buat 5 judul video pendek dengan format PERTANYAAN tentang batas tubuh manusia.

FORMAT WAJIB: "Berapa [SATUAN WAKTU] [AKTIVITAS] Sampai [ORGAN/BAGIAN TUBUH] [KATA KERJA EKSTREM]?"`;

        // Add version-specific instructions
        const versionPrompts = {
            '1': `VERSI 1: RELATABLE (REALISTIS)
ATURAN:
- Satuan waktu: Jam, Menit, Hari, Bulan, Tahun
- Aktivitas: Begadang, Main Game, Pakai Headset, Minum Kopi, Makan Pedas, Nonton Film, Jogging, Tahan Napas, Tidak Mandi, Main HP, Duduk, Makan Pizza, Minum Energi Drink, Merokok, Vape
- Organ: Otak, Paru-paru, Jantung, Mata, Telinga, Lambung, Kulit, Kaki, Leher, Ginjal
- Kata kerja: ERROR, MENJERIT, BUTA, MELELEH, MELEDAK, RUSAK, MATI RASA, BEKU, PATAH, BOCOR, HITAM, LUMPUH, HANCUR

Contoh:
- Berapa Jam Begadang Sampai Otakmu ERROR?
- Berapa Batang Rokok Sampai Paru-Parumu HANCUR?
- Berapa Jam Main Game Sampai Matamu MELELEH?`,

            '2': `VERSI 2: EKSTREM (DRAMATIS)
ATURAN:
- Satuan waktu: Detik, Menit, Jam (yang singkat-singkat)
- Aktivitas: Menahan napas, Lari sprint, Angkat beban maksimal, Scream, Nahan kencing, Nahan BAB, Makan super pedas level DEWA, Minum alkohol 90%, Lompat dari ketinggian
- Organ: Jantung, Paru-paru, Otak, Pembuluh darah, Pita suara, Lambung, Hati, Kandung kemih, Usus
- Kata kerja: MELEDAK, HANCUR, ROBEK, TERBAKAR, LUMPUH TOTAL, BERHENTI MENDADAK, KORSLEING, AMBYAR, REMUK

Contoh:
- Berapa Detik Menahan Napas Sampai Paru-Parumu ROBEK?
- Berapa Menit Nahan Kencing Sampai Kandung Kemihmu MELEDAK?
- Berapa Sendok Makan Sambal Level 10 Sampai Lambungmu TERBAKAR?`,

            '3': `VERSI 3: SURREAL (ABSURD)
ATURAN:
- Satuan waktu: Jam, Hari, Kali, Potong, Botol (tapi aktivitas absurd)
- Aktivitas: Menatap kulkas kosong, Memeluk bantal, Berdiri di depan kipas angin, Menekan tombol lift, Berbisik ke tembok, Nunggu pesan dibales, Nahan kentut, Nge-scroll TikTok, Nonton video kucing, Overthinking, Nahan lapar pas diet
- Organ: Otak, Mata, Telinga, Jari, Jempol, Pita suara, Usus, Lambung, Kesabaran, Eksistensi
- Kata kerja: BEKU, KERING, RATA, HILANG, MELEDAK, MEONG, BAU, MAKAN DIRI SENDIRI, HANG, FORMAT

Contoh:
- Berapa Jam Menatap Kulkas Kosong Sampai Otakmu BEKU?
- Berapa Kali Nge-scroll TikTok Sampai Jempolmu HILANG?
- Berapa Menit Nahan Kentut di Lift Sampai Ususmu MELEDAK?`,

            '4': `VERSI 4: FILOSOFIS ABSURD
ATURAN:
- Satuan waktu: Tahun, Bulan, Minggu, Hari, Jam
- Aktivitas: Mencari arti hidup, Overthinking sebelum tidur, Nahan uang di rekening, Nunggu jodoh, Mikirin masa depan, Nyesel masa lalu, Nahan ngomong, Nunggu gajian, Nahan sabar
- Organ: Otak, Hati, Jantung, Perasaan, Kesadaran, Eksistensi, Jiwa, Harapan, Sabar
- Kata kerja: KOSONG, HILANG, BERANAK, FORMAT, PATAH, AMBYAR, TERKUNCI, BUFFERING, ERROR

Contoh:
- Berapa Tahun Mencari Arti Hidup Sampai Otakmu KOSONG?
- Berapa Jam Overthinking Sebelum Tidur Sampai Matamu TERBUKA SELAMANYA?
- Berapa Hari Nahan Uang di Rekening Sampai Duitmu BERANAK?`,

            '5': `VERSI 5: RANDOM MURNI
ATURAN:
- Kombinasi BEBAS dan TIDAK TERDUGA dari semua kategori
- Boleh campur aktivitas realistis dengan absurd
- Boleh gunakan organ aneh: Bulu mata, Jempol kaki, Tulang ekor, Jari kelingking, Lubang hidung, Kuping, Alis
- Kata kerja: RONTOK, AMBYAR, BULAT, TERKUNCI, TEMBUS PANDANG, HILANG, BERJAMUR, BERKEMBANG, MENCIUT

Contoh:
- Berapa Kali Kedip Mata Sampai Bulu Matamu RONTOK?
- Berapa Jam Dengerin Lagu Galau Sampai Jantungmu AMBYAR?
- Berapa Potong Tahu Bulat Sampai Lambungmu BULAT?`,

            '6': `VERSI 6: AKTIVITAS ANEH
ATURAN:
- Aktivitas: Ngupas bawang, Main petak umpet, Pakai baju terbalik, Naik eskalator, Makan Indomie pake nasi, Ngupas telur, Ngepel lantai, Nyisir rambut kusut, Potong kuku, Cabut uban
- Organ: Mata, Leher, Kaki, Lambung, Jari, Kulit kepala, Kuku, Uban, Tangan
- Kata kerja: AIR TERJUN, KORBAN, TERUS NAIK, BINGUNG, PATAH, RONTOK, KUSUT, HILANG, BERKEMBANG

Contoh:
- Berapa Jam Ngupas Bawang Sampai Matamu AIR TERJUN?
- Berapa Hari Pakai Baju Terbalik Sampai Lehermu KORBAN?
- Berapa Kali Makan Indomie Pakai Nasi Sampai Lambungmu BINGUNG?`,

            '7': `VERSI 7: ILMIAH PALSU
ATURAN:
- Satuan waktu "ilmiah": Milidetik, Mikrodetik, Nanodetik, Desibel, Volt, Ampere, Watt, Gram, Miligram, Liter, Mililiter, CC, Derajat Celsius, pH, Hertz
- Aktivitas: Kepikiran mantan, Ngilu gigi, Kesetrum gagang pintu, Dengerin orang ngorok, Kena omongan pedas, Kena sinar matahari, Minum air es, Makan permen mentos
- Organ: Otak, Gigi, Rambut, Telinga, Hati, Kulit, Lambung, Perut, Saraf
- Kata kerja: HANG, KISUT, BERJAMUR, TULI SEMENTARA, BERDIRI SELAMANYA, MELEDAK, KORSLEING, MATI RASA

Contoh:
- Berapa Milidetik Kepikiran Mantan Sampai Otakmu HANG?
- Berapa Desibel Suara Orang Ngorok Sampai Telingamu TULI SEMENTARA?
- Berapa Volt Listrik Statis Pas Nyentuh Gagang Pintu Sampai Rambutmu BERDIRI SELAMANYA?`,

            '8': `VERSI 8: KESEHARIAN ABSURD
ATURAN:
- Aktivitas sehari-hari: Nyari remote TV, Bilang "bentar" tapi nggak jadi-jadi, Ngecas HP, Nahan ngantuk, Buka kulkas bolak-balik, Nyari kunci, Lupa bawa HP, Kepleset, Kesandung, Nahan bersin
- Organ: Mata, Otak, Jari, Listrik tubuh, Kepala, Kaki, Hidung, Paru-paru
- Kata kerja: SILINDER, MENERKA, HABIS, NODONG, HILANG, KRAM, TERBANG, MELEDAK, TERTAHAN

Contoh:
- Berapa Jam Nyari Remote TV Sampai Matamu SILINDER?
- Berapa Kali Bilang "Bentar" Tapi Nggak Jadi-Jadi Sampai Otakmu MENERKA?
- Berapa Menit Nahan Ngantuk Pas Kerja Sampai Kepalamu NODONG?`,

            '9': `VERSI 9: FANTASI
ATURAN:
- Aktivitas fantasi: Terbang di mimpi, Minum ramuan cinta, Jadi manusia silver, Baca buku terbalik, Berenang di lumpur, Ke hutan ajaib, Bertemu peri, Naik karpet terbang, Nelpon hantu, Main sama kuntilanak
- Organ: Sayap, Jantung, Kulit, Otak, Tubuh, Mata, Telinga, Hati
- Kata kerja: PATAH, TERHIPNOTIS, MENGKILAP, MIRROR, MEMBATU, SILAU, TULI, LUMER

Contoh:
- Berapa Jam Terbang di Mimpi Sampai Sayapmu PATAH?
- Berapa Botol Ramuan Cinta Sampai Jantungmu TERHIPNOTIS?
- Berapa Hari Jadi Manusia Silver Sampai Kulitmu MENGKILAP?`,

            '10': `VERSI 10: DIGITAL
ATURAN:
- Aktivitas digital: Stuck di loading screen, Update status galau, Download game, Scan QR code, Ngetik panjang, Video call lemot, Streaming buffering, Main game lag, Screenshot, Edit video
- Organ: Otak, Jari, Mata, Koneksi, Sabar, Kuota, Memori, Baterai
- Kata kerja: BUFFERING, KRAM, SILAU, FORMAT, HABIS, ERROR, HANG, LOW BAT, CRASH

Contoh:
- Berapa Jam Stuck di Loading Screen Sampai Otakmu BUFFERING?
- Berapa Kali Update Status Galau Sampai Jari-jarimu KRAM?
- Berapa Menit Scan QR Code Sampai Matamu JADI KAMERA?`
        };

        const fullPrompt = basePrompt + '\n\n' + (versionPrompts[version] || versionPrompts['1']) + '\n\nTulis nomor 1-5 saja. Hanya judul. Gunakan variasi baru. Jangan ulangi contoh yang diberikan.';

        const body = {
            model: GROQ_MODEL,
            messages: [{ role: "user", content: fullPrompt }],
            temperature: 1.0,
            max_tokens: 1000
        };

        try {
            const resp = await fetch(GROQ_URL, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!resp.ok) {
                const errData = await resp.json().catch(() => ({}));
                throw new Error(errData.error?.message || `Error ${resp.status}`);
            }

            const data = await resp.json();
            const content = data.choices[0]?.message?.content || "";
            const lines = content.split('\n').filter(l => l.trim().match(/^\d+\./));
            const ideas = [];
            
            for (let line of lines) {
                const withoutNumber = line.replace(/^\d+\.\s*/, '').trim();
                if (withoutNumber) ideas.push(withoutNumber);
            }
            
            if (ideas.length === 0) throw new Error('Tidak ada ide yang dihasilkan');
            return ideas.slice(0, 5);
            
        } catch (error) {
            console.error('Error:', error);
            throw error;
        }
    }

    async function callGroqForScript(apiKey, ideaTitle) {
        const systemPrompt = `You are a video scriptwriter for a viral YouTube Shorts channel. 

Write a script in INDONESIAN language based on this title: "${ideaTitle}"

GAYA PENULISAN: Tenang, klinis tapi conversational, second-person ("kamu"), kalimat pendek.

STRUKTUR SCRIPT:
1. Buka dengan judul
2. HOOK: satu kalimat penasaran
3. Timeline dengan "Selama X [satuan waktu]"
4. Fokus pada organ yang disebutkan
5. Akhiri dengan kegagalan total

CONTOH script untuk "Berapa Batang Rokok Sampai Paru-Parumu HANCUR?":
Berapa Batang Rokok Sampai Paru-Parumu HANCUR?
Tanpa kamu sadari, paru-parumu sedang mengalami kerusakan yang tidak dapat diperbaiki.
Selama 1 tahun, kamu masih merasa sehat. Paru-parumu masih dapat bernapas dengan baik.
Selama 5 tahun, kamu mulai merasakan kesulitan bernapas. Paru-parumu mulai mengalami peradangan.
Selama 10 tahun, paru-parumu mulai mengalami fibrosis. Kamu merasakan sakit di dada.
Selama 20 tahun, paru-parumu HANCUR total. Kamu tidak bisa bernapas normal.

After the script, create 3-5 scene breakdowns. For EACH scene, use this EXACT formula for image prompts:

**RUMUS PROMPT: "Place the skeleton character" + [AKSI/POSISI] + [KONTEKS LINGKUNGAN] + [DETAIL PROPERTI] + [TIPE CAHAYA] + [SUDUT KAMERA] + [EFEK VISUAL] + "Rendered in clean cinematic 3D, highly detailed."**

**CRITICAL RULES:**
- Scene 1 MUST show the ACTIVITY from the title
- ALL scenes MUST show progression of that activity
- The character MUST be doing the activity in EVERY scene
- Use "Place the skeleton character" at the START of EVERY image prompt
- End EVERY image prompt with "Rendered in clean cinematic 3D, highly detailed."

Format output:
===SCRIPT===
(script in Indonesian)
===SCENES===
Scene 1:
Time: [from script]
Environment: [location]
Image prompt: [Place the skeleton character... Rendered in clean cinematic 3D, highly detailed.]
Video prompt: [subtle movement description]

Scene 2:
...`;

        const body = {
            model: GROQ_MODEL,
            messages: [{ role: "user", content: systemPrompt }],
            temperature: 0.8,
            max_tokens: 5000
        };

        try {
            const resp = await fetch(GROQ_URL, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!resp.ok) {
                const errData = await resp.json().catch(() => ({}));
                throw new Error(errData.error?.message || `Error ${resp.status}`);
            }

            const data = await resp.json();
            const fullContent = data.choices[0]?.message?.content || "";
            const rawResponse = fullContent;

            let scriptPart = "";
            let scenesPart = "";
            
            if (fullContent.includes("===SCRIPT===") && fullContent.includes("===SCENES===")) {
                const parts = fullContent.split("===SCENES===");
                scriptPart = parts[0].replace("===SCRIPT===", "").trim();
                scenesPart = parts[1] || "";
            } else {
                const error = new Error('Format response tidak sesuai');
                error.rawResponse = rawResponse;
                throw error;
async function callGroqForScript(apiKey, ideaTitle) {
    const systemPrompt = `You are a video scriptwriter for a viral YouTube Shorts channel. 

Write a script in INDONESIAN language based on this title: "${ideaTitle}"

GAYA PENULISAN: Tenang, klinis tapi conversational, second-person ("kamu"), kalimat pendek.

STRUKTUR SCRIPT:
1. Buka dengan judul
2. HOOK: satu kalimat penasaran
3. Timeline dengan "Selama X [satuan waktu]"
4. Fokus pada organ yang disebutkan
5. Akhiri dengan kegagalan total

CONTOH script:
${ideaTitle}
Tanpa kamu sadari, [organ]-mu sedang mengalami [proses kerusakan].
Selama [waktu 1], [deskripsi kondisi awal].
Selama [waktu 2], [deskripsi progres kerusakan].
Selama [waktu 3], [deskripsi kerusakan parah].
Pada [waktu akhir], [organ]-mu [KATA KERJA EKSTREM] total.

After the script, create 3-5 scene breakdowns. 

**CRITICAL RULE FOR ENVIRONMENT:**
The ENVIRONMENT for each scene MUST be DIRECTLY INFERRED from the script's timeline and context.

Examples of ENVIRONMENT based on activity:
- Angkat beban ‚Üí HARUS "heavy industrial gym", "weightlifting platform", "powerlifting gym", "training facility with squat racks"
- Lari/jogging ‚Üí HARUS "outdoor running track", "park with jogging path", "treadmill at gym"
- Main game ‚Üí HARUS "dark gaming room with RGB lights", "esports arena", "gaming setup with multiple monitors"
- Merokok ‚Üí HARUS "living room with ashtrays", "balcony at night", "smoking area"
- Makan pedas ‚Üí HARUS "kitchen table", "restaurant with spicy food", "food court"

**NEVER use generic environments like:**
- "latar belakang abu-abu" (gray background)
- "ruangan kosong" (empty room)
- "berdiri di depan cermin" (standing in front of mirror) - unless script specifically mentions checking form in mirror
- "warna abu-abu" (gray color)

**FOR EACH IMAGE PROMPT, use this EXACT formula:**

"Place the skeleton character [SPECIFIC ACTION based on script timeline] + [SPECIFIC ENVIRONMENT that matches the activity] + [SPECIFIC PROPS related to activity] + [SPECIFIC LIGHTING that fits the mood] + [SPECIFIC CAMERA ANGLE that emphasizes the action] + [SPECIFIC VISUAL EFFECTS that enhance realism]. Rendered in clean cinematic 3D, highly detailed."

**EXAMPLES OF GOOD VS BAD PROMPTS:**

‚ùå BAD (generic, doesn't match context):
"Place the skeleton character melakukan angkat beban dengan barbel di tangan, berdiri di depan cermin, dengan latar belakang warna abu-abu, cahaya putih, sudut kamera 45 derajat, efek visual bayangan, Rendered in clean cinematic 3D, highly detailed."

‚úÖ GOOD (specific, matches gym context):
"Place the skeleton character inside a heavy industrial gym, performing a maximum deadlift with an overloaded barbell, sweat visible on its transparent skull, standing on a rubber lifting platform with weight plates scattered around. Use dramatic top-down gym lighting and shoot from a low front cinematic angle to emphasize strain and muscle tension. Add subtle chalk dust particles floating in the air, tense body posture with veins bulging through transparent skin, and slight camera shake effect from the weight impact. Rendered in clean cinematic 3D, highly detailed."

‚úÖ GOOD (progressive scenes that match timeline):

Scene 1 (Pemanasan - 0 menit):
"Place the skeleton character in a well-lit industrial gym with yellow overhead lights, standing at a squat rack, doing light warm-up reps with an empty barbell to test grip, multiple weight racks visible in background with other gym equipment. Use warm ambient lighting and a medium wide shot showing proper form. Add subtle dust particles and clean gym atmosphere with mirrors on walls reflecting the space. Rendered in clean cinematic 3D, highly detailed."

Scene 2 (Menit ke-5 - tekanan mulai terasa):
"Place the skeleton character on a deadlift platform in the same gym, now loading heavy 100kg plates onto the barbell, hands gripping the knurling tightly, transparent chest showing heart racing with visible blood flow pulsing faster. Use dramatic side lighting from gym windows and a low angle shot emphasizing the weight being loaded. Add sweat beginning to form on the skull and slight tension in the skeletal frame. Rendered in clean cinematic 3D, highly detailed."

Scene 3 (Menit ke-10 - tekanan maksimal):
"Place the skeleton character in the middle of a heavy deadlift at 180kg, back straight, arms locked, veins bulging visibly through transparent arms and neck, face contorted in effort, blood vessels in the chest area starting to show stress marks like cracks in glass. Use harsh top-down industrial lighting creating deep shadows under the barbell and a tight close-up shot on the straining arms and chest. Add chalk dust exploding from grip, sweat droplets flying, and subtle red glow indicating vascular pressure. Rendered in clean cinematic 3D, highly detailed."

Scene 4 (Menit ke-12 - PEMBULUH DARAH ROBEK):
"Place the skeleton character collapsed on the gym floor beside the dropped barbell, weights still rattling, transparent body revealing multiple blood vessels in the chest and arms burst open with internal bleeding visible as red mist spreading through the transparent tissue, eyes wide open and lifeless. Use emergency lighting effect with flickering gym lights and a dramatic overhead shot showing the full collapse. Add blood particles dispersing through transparent body, weight plates still spinning on the bar, and distant gym-goers rushing to help in background blur. Rendered in clean cinematic 3D, highly detailed."

**ENVIRONMENT CHECKLIST for Each Scene:**
- [ ] Apakah lingkungan SPESIFIK untuk aktivitas? (gym, dapur, kamar gaming, dll)
- [ ] Apakah PROPS sesuai? (barbel, panci pedas, controller, rokok)
- [ ] Apakah SUASANA berubah sesuai timeline? (bersih ‚Üí berantakan ‚Üí chaos)
- [ ] Apakah PENCAHAYAAN mendukung mood? (cerah ‚Üí suram ‚Üí dramatis)
- [ ] Apakah DETAIL kecil ada? (chalk dust, asap, keringat, uap)

**CRITICAL RULES:**
- Scene 1 MUST establish the ENVIRONMENT clearly
- Each scene's environment MUST evolve with the timeline
- NEVER use generic backgrounds
- The character MUST interact with the environment naturally
- Props MUST show progression (empty ashtray ‚Üí full ashtray, light weights ‚Üí heavy weights)

Format output:
===SCRIPT===
(script in Indonesian)
===SCENES===
Scene 1:
Time: [from script - MUST include specific time like "Pemanasan - 0 menit"]
Environment: [SPECIFIC location with details]
Image prompt: [Place the skeleton character... Rendered in clean cinematic 3D, highly detailed.]
Video prompt: [subtle movement description]

Scene 2:
...`;

    const body = {
        model: GROQ_MODEL,
        messages: [{ role: "user", content: systemPrompt }],
        temperature: 0.8,
        max_tokens: 6000
    };

    try {
        const resp = await fetch(GROQ_URL, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (!resp.ok) {
            const errData = await resp.json().catch(() => ({}));
            throw new Error(errData.error?.message || `Error ${resp.status}`);
        }

        const data = await resp.json();
        const fullContent = data.choices[0]?.message?.content || "";
        const rawResponse = fullContent;

        let scriptPart = "";
        let scenesPart = "";
        
        if (fullContent.includes("===SCRIPT===") && fullContent.includes("===SCENES===")) {
            const parts = fullContent.split("===SCENES===");
            scriptPart = parts[0].replace("===SCRIPT===", "").trim();
            scenesPart = parts[1] || "";
        } else {
            const error = new Error('Format response tidak sesuai');
            error.rawResponse = rawResponse;
            throw error;
        }

        const sceneRegex = /Scene\s*\d+.*?:\s*Time:\s*(.*?)\s*Environment:\s*(.*?)\s*Image prompt:\s*(.*?)\s*Video prompt:\s*(.*?)(?=\n\s*Scene|\n*$)/gis;
        const scenes = [];
        let match;
        
        while ((match = sceneRegex.exec(scenesPart)) !== null) {
            scenes.push({
                time: match[1].trim(),
                environment: match[2].trim(),
                imagePrompt: match[3].trim(),
                videoPrompt: match[4].trim(),
                narration: scriptPart
            });
        }

        if (scenes.length === 0) {
            const error = new Error('Tidak ada scene yang ditemukan');
            error.rawResponse = rawResponse;
            throw error;
        }

        return { script: scriptPart, scenes: scenes };
        
    } catch (error) {
        console.error('Error:', error);
        throw error;
    }
}

    window.copyText = copyText;
    window.toggleFullPrompt = toggleFullPrompt;
</script>
</body>
</html>
