<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>batas ¬∑ manusia ‚Äî generator ide video</title>
    <!-- Plus Jakarta Sans untuk logo dan judul -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Inter untuk lainnya -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300..700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", sans-serif;
            background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 1.8rem;
            color: #333333;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Logo di tengah dengan Plus Jakarta Sans - ungu neon */
        .logo-container {
            text-align: center;
            margin: 0.5rem 0 2.5rem 0;
        }
        .logo-container h1 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 2.8rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #a855f7, #d946ef);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            text-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
        }
        .logo-container .sub {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 400;
            color: #666666;
            font-size: 1rem;
            margin-top: 0.25rem;
            letter-spacing: 0.3px;
            text-shadow: 0 0 10px rgba(168, 85, 247, 0.2);
        }

        /* Card dengan efek glass putih */
        .card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border-radius: 2.5rem;
            padding: 2.2rem 2.2rem;
            box-shadow: 0 25px 50px -12px rgba(168, 85, 247, 0.2), 0 4px 18px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(168, 85, 247, 0.2);
            transition: all 0.2s ease;
        }

        /* Input API Key */
        .api-key-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 1rem 1.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.8rem;
            border: 1px solid rgba(168, 85, 247, 0.3);
            box-shadow: 0 10px 15px -3px rgba(168, 85, 247, 0.1);
        }
        .api-key-label {
            font-weight: 600;
            color: #a855f7;
            min-width: 90px;
            font-size: 0.95rem;
        }
        .api-key-input {
            flex: 1;
            min-width: 220px;
            padding: 0.7rem 1.3rem;
            border-radius: 3rem;
            border: 2px solid #e5e7eb;
            font-family: 'Inter', monospace;
            font-size: 0.9rem;
            background: white;
            color: #333333;
            outline: none;
            transition: 0.15s;
        }
        .api-key-input:focus {
            border-color: #a855f7;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
        }
        .api-key-hint {
            font-size: 0.8rem;
            color: #666666;
            width: 100%;
            margin-top: 0.2rem;
        }

        /* Tombol gradasi ungu neon */
        .button-generate {
            background: linear-gradient(135deg, #a855f7, #d946ef);
            border: none;
            padding: 0.8rem 2.2rem;
            border-radius: 3rem;
            font-weight: 600;
            font-size: 1rem;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            cursor: pointer;
            box-shadow: 0 10px 25px -5px rgba(168, 85, 247, 0.3);
            transition: 0.2s;
            letter-spacing: 0.01em;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .button-generate:hover {
            background: linear-gradient(135deg, #9333ea, #c026d3);
            box-shadow: 0 15px 30px -5px rgba(168, 85, 247, 0.4);
            transform: scale(1.02);
        }

        .button-generate:disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(0.3);
        }

        .button-secondary {
            background: white;
            border: 1.5px solid #a855f7;
            padding: 0.5rem 1.5rem;
            border-radius: 3rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: #a855f7;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.1);
            transition: 0.1s;
        }
        .button-secondary:hover {
            background: #a855f7;
            color: white;
            border-color: #d946ef;
        }

        .idea-grid {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin: 1.5rem 0 1.5rem;
        }

        .idea-item {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 0.9rem 1.5rem;
            border-left: 8px solid #a855f7;
            box-shadow: 0 10px 15px -3px rgba(168, 85, 247, 0.1);
            transition: 0.15s ease;
            cursor: pointer;
            border: 1px solid rgba(168, 85, 247, 0.2);
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .idea-item:hover {
            background: white;
            border-left-width: 12px;
            border-left-color: #d946ef;
            box-shadow: 0 15px 20px -5px rgba(168, 85, 247, 0.2);
        }

        .idea-item.selected {
            background: white;
            border-left-color: #d946ef;
            border: 2px solid #a855f7;
            box-shadow: 0 8px 25px rgba(168, 85, 247, 0.2);
        }

        .idea-number {
            width: 2.3rem;
            height: 2.3rem;
            background: linear-gradient(135deg, #a855f7, #d946ef);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            font-size: 0.9rem;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.3);
        }

        .idea-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333333;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .script-output {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(16px);
            border-radius: 2.5rem;
            padding: 1.8rem;
            border: 1px solid rgba(168, 85, 247, 0.2);
            box-shadow: 0 20px 40px -15px rgba(168, 85, 247, 0.15);
            margin-top: 2rem;
        }

        .script-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #a855f7;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .script-text {
            font-size: 1.1rem;
            line-height: 1.6;
            white-space: pre-wrap;
            color: #333333;
            font-weight: 400;
            border-left: 4px solid #a855f7;
            padding-left: 1.3rem;
        }

        .scene-prompt {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 1.3rem;
            margin: 1.5rem 0 0.5rem;
            border: 1px dashed #a855f7;
        }

        .scene-title {
            font-weight: 700;
            color: #a855f7;
            margin-bottom: 0.8rem;
            font-size: 1.2rem;
        }

        .prompt-container {
            background: white;
            border-radius: 1.3rem;
            padding: 0.9rem 1.2rem;
            margin-bottom: 0.8rem;
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .badge {
            background: linear-gradient(135deg, #a855f7, #d946ef);
            border-radius: 3rem;
            padding: 0.2rem 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            display: inline-block;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.2);
        }

        .copy-btn {
            background: none;
            border: 1px solid #a855f7;
            color: #a855f7;
            padding: 0.2rem 1rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.1s;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .copy-btn:hover {
            background: #a855f7;
            color: white;
        }

        .copy-btn.copied {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .prompt-text {
            font-size: 0.9rem;
            color: #333333;
            line-height: 1.5;
            word-break: break-word;
        }

        .prompt-full {
            display: none;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #a855f7;
        }

        .show-more {
            color: #a855f7;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 0.25rem;
            display: inline-block;
        }

        hr {
            border: 0.5px solid rgba(168, 85, 247, 0.2);
            margin: 1.2rem 0;
        }

        .action-bottom {
            display: flex;
            justify-content: center;
            margin: 1rem 0 0.2rem;
        }

        .selected-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            border-radius: 4rem;
            padding: 0.5rem 1.5rem;
            margin: 1rem 0 0.5rem;
            border: 1px solid #a855f7;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.1);
        }

        #selectedDisplay {
            color: #a855f7;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .footer-credit {
            text-align: center;
            color: #a855f7;
            margin-top: 2rem;
            font-size: 0.8rem;
        }

        .error-message {
            background: #fee2e2;
            color: #b91c1c;
            padding: 0.8rem 1.5rem;
            border-radius: 3rem;
            margin: 1rem 0;
            border: 1px solid #ef4444;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .raw-response {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: monospace;
            font-size: 0.8rem;
            padding: 1rem;
            border-radius: 1rem;
            margin-top: 1rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow: auto;
        }

        .get-key-link {
            color: #a855f7;
            font-weight: 600;
            text-decoration: none;
            border-bottom: 1px dashed #a855f7;
        }
        .get-key-link:hover {
            color: #d946ef;
        }

        .audio-player-container {
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 2rem;
            border: 1px solid rgba(168, 85, 247, 0.3);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .audio-player-container audio {
            width: 100%;
            height: 40px;
            border-radius: 2rem;
        }

        .audio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #a855f7;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .voice-badge {
            background: rgba(168, 85, 247, 0.15);
            border: 1px solid #a855f7;
            color: #a855f7;
            padding: 0.2rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            margin-left: 0.5rem;
        }

        .loading-audio {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #a855f7;
            font-size: 0.9rem;
            padding: 0.5rem;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(168, 85, 247, 0.3);
            border-top-color: #a855f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="logo-container">
        <h1>batas ¬∑ manusia</h1>
        <div class="sub">kegagalan biologis dalam visual sunyi</div>
    </div>

    <div class="card">
        <div class="api-key-container">
            <span class="api-key-label">üîë Groq Key</span>
            <input type="password" id="apiKeyInput" class="api-key-input" placeholder="gsk_...">
            <div class="api-key-hint">
                <a href="https://console.groq.com/keys" target="_blank" class="get-key-link">Dapatkan key</a>
            </div>
        </div>

        <div class="api-key-container">
            <span class="api-key-label">üé§ ElevenLabs Key</span>
            <input type="password" id="elevenLabsKeyInput" class="api-key-input" placeholder="elevenlabs_...">
            <div class="api-key-hint">
                <a href="https://elevenlabs.io/app/settings/api-keys" target="_blank" class="get-key-link">Dapatkan key</a> (opsional)
                <span class="voice-badge">‚ú® Rachel</span>
            </div>
        </div>

        <div id="ideaList" class="idea-grid">
            <div style="text-align: center; color: #666666; padding: 1.5rem; font-style: italic; font-size: 0.95rem;">
                Masukkan API Key, lalu generate
            </div>
        </div>

        <div id="selectedArea" style="display: none;">
            <div class="selected-bar">
                <span id="selectedDisplay">‚úî ide terpilih: </span>
                <button id="generateScriptBtn" class="button-secondary">üé¨ buat naskah</button>
            </div>
        </div>

        <div class="action-bottom">
            <button id="generateIdeasBtn" class="button-generate">
                <span>‚ú®</span> generate 5 ide fresh
            </button>
        </div>
    </div>

    <div id="scriptContainer" class="script-output" style="display: none;">
        <div class="script-label">naskah (bahasa indonesia) ¬∑ 45‚Äì70 detik</div>
        <div id="scriptText" class="script-text"></div>
        
        <div id="audioContainer" style="display: none;" class="audio-player-container">
            <div class="audio-label">
                <span>üéµ Suara Rachel</span>
            </div>
            <audio id="audioPlayer" controls preload="metadata">
                <source src="" type="audio/mpeg">
                Browser tidak mendukung audio player.
            </audio>
            <div id="audioLoading" class="loading-audio" style="display: none;">
                <div class="spinner"></div>
                <span>Menghasilkan suara...</span>
            </div>
        </div>

        <hr>
        <div class="script-label">image prompts (english ‚Äî format rumus)</div>
        <div id="scenePrompts"></div>
        <div id="debugResponse" style="display: none;" class="raw-response"></div>
    </div>

    <div class="footer-credit">
        [Subjek] + [Aksi] + [Lingkungan] + [Cahaya] + [Sudut Kamera] + [VFX] + Render 3D
    </div>
</div>

<script>
    const GROQ_URL = "https://api.groq.com/openai/v1/chat/completions";
    const GROQ_MODEL = "llama-3.3-70b-versatile";
    const ELEVENLABS_URL = "https://api.elevenlabs.io/v1";
    const RACHEL_VOICE_ID = "21m00Tcm4TlvDq8ikWAM";
    
    const STORAGE_KEYS = {
        GROQ_API_KEY: 'batasManusia_groqKey',
        ELEVENLABS_API_KEY: 'batasManusia_elevenLabsKey'
    };
    
    let generatedIdeas = [];
    let selectedIdeaIndex = null;

    const generateIdeasBtn = document.getElementById('generateIdeasBtn');
    const ideaListDiv = document.getElementById('ideaList');
    const selectedArea = document.getElementById('selectedArea');
    const selectedDisplay = document.getElementById('selectedDisplay');
    const generateScriptBtn = document.getElementById('generateScriptBtn');
    const scriptContainer = document.getElementById('scriptContainer');
    const scriptTextDiv = document.getElementById('scriptText');
    const scenePromptsDiv = document.getElementById('scenePrompts');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const elevenLabsKeyInput = document.getElementById('elevenLabsKeyInput');
    const debugResponse = document.getElementById('debugResponse');
    
    const audioContainer = document.getElementById('audioContainer');
    const audioPlayer = document.getElementById('audioPlayer');
    const audioLoading = document.getElementById('audioLoading');

    function loadSavedKeys() {
        const savedGroqKey = localStorage.getItem(STORAGE_KEYS.GROQ_API_KEY);
        if (savedGroqKey) apiKeyInput.value = savedGroqKey;
        
        const savedElevenLabsKey = localStorage.getItem(STORAGE_KEYS.ELEVENLABS_API_KEY);
        if (savedElevenLabsKey) elevenLabsKeyInput.value = savedElevenLabsKey;
    }

    function saveApiKey(key, value) {
        if (value) localStorage.setItem(key, value);
        else localStorage.removeItem(key);
    }

    function getApiKey() { return apiKeyInput.value.trim(); }
    function getElevenLabsKey() { return elevenLabsKeyInput.value.trim(); }
    function isValidApiKey(key) { return key.startsWith('gsk_') && key.length > 20; }

    apiKeyInput.addEventListener('input', () => saveApiKey(STORAGE_KEYS.GROQ_API_KEY, getApiKey()));
    elevenLabsKeyInput.addEventListener('input', () => saveApiKey(STORAGE_KEYS.ELEVENLABS_API_KEY, getElevenLabsKey()));

    async function generateAudioFile(text) {
        const apiKey = getElevenLabsKey();
        if (!apiKey) { audioContainer.style.display = 'none'; return null; }

        try {
            audioLoading.style.display = 'flex';
            audioContainer.style.display = 'block';
            audioPlayer.src = '';
            
            const response = await fetch(`${ELEVENLABS_URL}/text-to-speech/${RACHEL_VOICE_ID}`, {
                method: 'POST',
                headers: {
                    'xi-api-key': apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: text,
                    model_id: 'eleven_multilingual_v2',
                    voice_settings: { stability: 0.75, similarity_boost: 0.75, style: 0.0, speed: 1.0, use_speaker_boost: true }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail?.message || 'Gagal generate suara');
            }

            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            audioPlayer.src = audioUrl;
            audioPlayer.load();
            audioLoading.style.display = 'none';
            return audioUrl;
            
        } catch (error) {
            console.error('TTS error:', error);
            audioLoading.style.display = 'none';
            audioContainer.style.display = 'none';
            return null;
        }
    }

    generateIdeasBtn.addEventListener('click', async () => {
        const apiKey = getApiKey();
        
        if (!apiKey) {
            ideaListDiv.innerHTML = `<div class="error-message">‚ùå Masukkan API Key</div>`;
            return;
        }
        
        if (!isValidApiKey(apiKey)) {
            ideaListDiv.innerHTML = `<div class="error-message">‚ùå Format key harus "gsk_" + minimal 20 karakter</div>`;
            return;
        }

        generateIdeasBtn.disabled = true;
        generateIdeasBtn.innerHTML = '‚è≥ memproses...';
        ideaListDiv.innerHTML = `<div style="padding: 1.5rem; color:#666666; text-align:center;">‚è≥ mencari 5 ide fresh...</div>`;

        try {
            const ideas = await callGroqForIdeas(apiKey);
            generatedIdeas = ideas;
            renderIdeaList(ideas);
            selectedArea.style.display = 'none';
            scriptContainer.style.display = 'none';
            selectedIdeaIndex = null;
            
        } catch (e) {
            if (e.message.includes('401') || e.message.includes('Invalid API Key')) {
                ideaListDiv.innerHTML = `<div class="error-message">‚ùå API Key tidak valid. <a href="https://console.groq.com/keys" target="_blank" style="color:#b91c1c;">Cek di sini</a></div>`;
            } else {
                ideaListDiv.innerHTML = `<div class="error-message">‚ùå Gagal: ${e.message}</div>`;
            }
        } finally {
            generateIdeasBtn.disabled = false;
            generateIdeasBtn.innerHTML = '‚ú® generate 5 ide fresh';
        }
    });

    function selectIdea(index) {
        selectedIdeaIndex = index;
        const items = document.querySelectorAll('.idea-item');
        items.forEach((item, i) => {
            if (i === index) item.classList.add('selected');
            else item.classList.remove('selected');
        });
        selectedDisplay.innerText = `‚úî ide terpilih: ${generatedIdeas[index]}`;
        selectedArea.style.display = 'block';
        scriptContainer.style.display = 'none';
    }

    function renderIdeaList(ideas) {
        if (!ideas || ideas.length === 0) {
            ideaListDiv.innerHTML = `<div style="padding:1.5rem; text-align:center;">tidak ada ide</div>`;
            return;
        }
        let html = '';
        ideas.forEach((idea, idx) => {
            html += `
                <div class="idea-item" data-index="${idx}">
                    <div class="idea-number">${idx+1}</div>
                    <div class="idea-content">
                        <div class="idea-title">${idea}</div>
                    </div>
                </div>
            `;
        });
        ideaListDiv.innerHTML = html;
        document.querySelectorAll('.idea-item').forEach((el) => {
            el.addEventListener('click', (e) => {
                const index = parseInt(el.dataset.index, 10);
                selectIdea(index);
            });
        });
    }

    async function copyText(button, text) {
        try {
            await navigator.clipboard.writeText(text);
            button.classList.add('copied');
            button.innerHTML = '‚úì copied';
            setTimeout(() => {
                button.classList.remove('copied');
                button.innerHTML = 'üìã copy';
            }, 2000);
        } catch (err) {
            alert('Gagal menyalin teks');
        }
    }

    function toggleFullPrompt(showMoreEl) {
        const fullDiv = showMoreEl.parentElement.querySelector('.prompt-full');
        if (fullDiv.style.display === 'none' || !fullDiv.style.display) {
            fullDiv.style.display = 'block';
            showMoreEl.textContent = 'sembunyikan';
        } else {
            fullDiv.style.display = 'none';
            showMoreEl.textContent = 'lihat selengkapnya';
        }
    }

    function detectFramingType(text) {
        const t = text.toLowerCase();
        
        if (t.includes("close-up") || t.includes("closeup")) return "closeup";
        if (t.includes("medium shot")) return "medium";
        if (t.includes("wide shot")) return "wide";
        return "full-body";
    }

    generateScriptBtn.addEventListener('click', async () => {
        if (selectedIdeaIndex === null || !generatedIdeas[selectedIdeaIndex]) return;

        const apiKey = getApiKey();
        if (!apiKey || !isValidApiKey(apiKey)) {
            alert('API Key tidak valid');
            return;
        }

        const selectedIdea = generatedIdeas[selectedIdeaIndex];
        generateScriptBtn.disabled = true;
        generateScriptBtn.innerHTML = '‚è≥ menyusun naskah...';
        scriptContainer.style.display = 'block';
        scriptTextDiv.innerText = 'Menunggu Groq...';
        scenePromptsDiv.innerHTML = '';
        debugResponse.style.display = 'none';
        audioContainer.style.display = 'none';

        try {
            const result = await callGroqForScript(apiKey, selectedIdea);
            
            scriptTextDiv.innerText = result.script;

            if (getElevenLabsKey()) {
                await generateAudioFile(result.script);
            }

            let scenesHtml = '';
            result.scenes.forEach((scene, idx) => {
                const framingType = detectFramingType(scene.imagePrompt);
                
                scenesHtml += `
                    <div class="scene-prompt">
                        <div class="scene-title">‚è±Ô∏è ${scene.time} ¬∑ ${framingType}</div>
                        
                        <div class="prompt-container">
                            <div class="prompt-header">
                                <span class="badge">üñºÔ∏è IMAGE PROMPT</span>
                                <button class="copy-btn" onclick="copyText(this, \`${scene.imagePrompt.replace(/`/g, '\\`')}\`)">üìã copy</button>
                            </div>
                            <div class="prompt-text">${scene.imagePrompt.substring(0, 200)}...</div>
                            <div class="prompt-full">${scene.imagePrompt}</div>
                            <span class="show-more" onclick="toggleFullPrompt(this)">lihat selengkapnya</span>
                        </div>

                        <div class="prompt-container">
                            <div class="prompt-header">
                                <span class="badge">üé• VIDEO PROMPT</span>
                                <button class="copy-btn" onclick="copyText(this, \`${scene.videoPrompt.replace(/`/g, '\\`')}\`)">üìã copy</button>
                            </div>
                            <div class="prompt-text">${scene.videoPrompt.substring(0, 150)}...</div>
                            <div class="prompt-full">${scene.videoPrompt}</div>
                            <span class="show-more" onclick="toggleFullPrompt(this)">lihat selengkapnya</span>
                        </div>
                    </div>
                `;
            });
            scenePromptsDiv.innerHTML = scenesHtml;
            
        } catch (e) {
            console.error('Error:', e);
            scriptTextDiv.innerText = '‚ùå GAGAL: ' + e.message;
            if (e.rawResponse) {
                debugResponse.textContent = 'Raw Response:\n' + e.rawResponse;
                debugResponse.style.display = 'block';
            }
        } finally {
            generateScriptBtn.disabled = false;
            generateScriptBtn.innerHTML = 'üé¨ buat naskah';
        }
    });

    loadSavedKeys();

    async function callGroqForIdeas(apiKey) {
        const prompt = `Buat 5 judul video pendek dengan format PERTANYAAN tentang batas tubuh manusia.

FORMAT WAJIB: "Berapa [SATUAN WAKTU] [AKTIVITAS] Sampai [ORGAN/BAGIAN TUBUH] [KATA KERJA EKSTREM]?"

ATURAN:
1. Satuan waktu: Jam, Menit, Detik, Hari, Potong, Botol, Batang, Kali, Persen
2. Aktivitas: Begadang, Main Game, Pakai Headset, Minum Kopi, Makan Pedas, Nonton Film, Jogging, Tahan Napas, Tidak Mandi, Tatap Matahari, Main HP, Duduk, Makan Pizza, Minum Energi Drink, Merokok
3. Organ/Bagian tubuh: Otak, Paru-paru, Jantung, Mata, Telinga, Lambung, Kulit, Kaki, Leher, Ginjal
4. Kata kerja ekstrem: ERROR, MENJERIT, JADI BATU, BUTA, MELELEH, MELEDAK, RUSAK, MATI RASA, BEKU, PATAH, BOCOR, HITAM, LUMPUH, HANCUR

Tulis nomor 1-5 saja. Hanya judul. Gunakan variasi baru.`;

        const body = {
            model: GROQ_MODEL,
            messages: [{ role: "user", content: prompt }],
            temperature: 1.0,
            max_tokens: 800
        };

        try {
            const resp = await fetch(GROQ_URL, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!resp.ok) {
                const errData = await resp.json().catch(() => ({}));
                throw new Error(errData.error?.message || `Error ${resp.status}`);
            }

            const data = await resp.json();
            const content = data.choices[0]?.message?.content || "";
            const lines = content.split('\n').filter(l => l.trim().match(/^\d+\./));
            const ideas = [];
            
            for (let line of lines) {
                const withoutNumber = line.replace(/^\d+\.\s*/, '').trim();
                if (withoutNumber) ideas.push(withoutNumber);
            }
            
            if (ideas.length === 0) throw new Error('Tidak ada ide yang dihasilkan');
            return ideas.slice(0, 5);
            
        } catch (error) {
            console.error('Error:', error);
            throw error;
        }
    }

    async function callGroqForScript(apiKey, ideaTitle) {
        const systemPrompt = `You are a video scriptwriter for a viral YouTube Shorts channel. 

Write a script in INDONESIAN language based on this title: "${ideaTitle}"

GAYA PENULISAN: Tenang, klinis tapi conversational, second-person ("kamu"), kalimat pendek.

STRUKTUR SCRIPT:
1. Buka dengan judul
2. HOOK: satu kalimat penasaran
3. Timeline dengan "Selama X [satuan waktu]"
4. Fokus pada organ yang disebutkan
5. Akhiri dengan kegagalan total

CONTOH script untuk "Berapa Batang Rokok Sampai Paru-Parumu HANCUR?":
Berapa Batang Rokok Sampai Paru-Parumu HANCUR?
Tanpa kamu sadari, paru-parumu sedang mengalami kerusakan yang tidak dapat diperbaiki.
Selama 1 tahun, kamu masih merasa sehat. Paru-parumu masih dapat bernapas dengan baik.
Selama 5 tahun, kamu mulai merasakan kesulitan bernapas. Paru-parumu mulai mengalami peradangan.
Selama 10 tahun, paru-parumu mulai mengalami fibrosis. Kamu merasakan sakit di dada.
Selama 20 tahun, paru-parumu HANCUR total. Kamu tidak bisa bernapas normal.

After the script, create 3-5 scene breakdowns. For EACH scene, use this EXACT formula for image prompts:

**RUMUS PROMPT: [SUBJEK] + [AKSI/POSISI] + [KONTEKS LINGKUNGAN] + [DETAIL PROPERTI] + [TIPE CAHAYA] + [SUDUT KAMERA] + [EFEK VISUAL] + [GAYA RENDER]**

**CONTOH PROMPT YANG BENAR (rokok):**

Scene 1 (Tahun 1):
"Place the skeleton character sitting casually on a modern sofa, holding a freshly lit cigarette between two fingers, smoke curling upward, with a clean ashtray on the side table beside a morning coffee cup. Sunlight streams through large windows creating warm natural lighting and long soft shadows. Use a medium wide shot showing the relaxed posture. Add subtle morning haze and gentle sun rays. Rendered in clean cinematic 3D, highly detailed."

Scene 2 (Tahun 5):
"Place the skeleton character slumped on the same sofa, now surrounded by multiple ashtrays overflowing with cigarette butts, holding a cigarette with slightly trembling fingers. Harsh late afternoon light creates deep shadows across the room, dust particles visible in the fading light beams. Use a tighter medium shot focusing on the labored breathing. Add subtle smoke haze hanging in the air and discarded cigarette packs on floor. Rendered in clean cinematic 3D, highly detailed."

Scene 3 (Tahun 10):
"Place the skeleton character hunched forward on the edge of the sofa, one hand clutching its chest where the transparent ribcage reveals lungs turning dark and stiff with fibrous tissue, the other hand weakly holding a smoldering cigarette. Dim table lamp creates harsh dramatic lighting with deep shadows. Use a close-up shot focused on the chest area showing the damaged lungs. Add faint internal glow revealing scarred tissue and wisps of smoke escaping between ribs. Rendered in clean cinematic 3D, highly detailed."

Scene 4 (Tahun 20):
"Place the skeleton character collapsed on the floor beside the sofa, cigarette still clutched in lifeless fingers, the transparent chest cavity fully open revealing lungs completely blackened and crumbling like charcoal, pieces of lung tissue floating away like ash. Flickering table lamp creates strobe-like lighting effects, casting long dancing shadows. Use a dramatic low-angle shot showing the final collapse. Add lung fragments disintegrating into smoke particles. Rendered in clean cinematic 3D, highly detailed."

**CONTOH PROMPT YANG BENAR (main game):**

Scene 1:
"Place the skeleton character sitting upright in a gaming chair, hands on a mechanical keyboard and mouse, eyes fixed on a glowing monitor displaying a game lobby, with a fresh energy drink on the desk. RGB purple and blue lighting from the computer creates colorful rim lights on the transparent body. Use a low-angle shot emphasizing the focused posture. Add monitor glow and slight screen flicker. Rendered in clean cinematic 3D, highly detailed."

Scene 2:
"Place the skeleton character hunched forward in the gaming chair, one hand rubbing its eyes while the other still grips the mouse, multiple empty energy drink cans scattered around, monitor showing 2AM. Dim room lighting with monitor as primary light source creates deep shadows under the eyes. Use a medium shot capturing the exhaustion. Add eye strain effects and dark circles forming. Rendered in clean cinematic 3D, highly detailed."

**CRITICAL RULES:**
- Scene 1 MUST show the ACTIVITY from the title (smoking, gaming, eating, etc.)
- ALL scenes MUST show progression of that activity
- The character MUST be doing the activity in EVERY scene
- Use "Place the skeleton character" at the START of EVERY image prompt
- End EVERY image prompt with "Rendered in clean cinematic 3D, highly detailed."

Format output:
===SCRIPT===
(script in Indonesian)
===SCENES===
Scene 1:
Time: [from script]
Environment: [location]
Image prompt: [Place the skeleton character... Rendered in clean cinematic 3D, highly detailed.]
Video prompt: [subtle movement description]

Scene 2:
...`;

        const body = {
            model: GROQ_MODEL,
            messages: [{ role: "user", content: systemPrompt }],
            temperature: 0.8,
            max_tokens: 5000
        };

        try {
            const resp = await fetch(GROQ_URL, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!resp.ok) {
                const errData = await resp.json().catch(() => ({}));
                throw new Error(errData.error?.message || `Error ${resp.status}`);
            }

            const data = await resp.json();
            const fullContent = data.choices[0]?.message?.content || "";
            const rawResponse = fullContent;

            let scriptPart = "";
            let scenesPart = "";
            
            if (fullContent.includes("===SCRIPT===") && fullContent.includes("===SCENES===")) {
                const parts = fullContent.split("===SCENES===");
                scriptPart = parts[0].replace("===SCRIPT===", "").trim();
                scenesPart = parts[1] || "";
            } else {
                const error = new Error('Format response tidak sesuai');
                error.rawResponse = rawResponse;
                throw error;
            }

            const sceneRegex = /Scene\s*\d+.*?:\s*Time:\s*(.*?)\s*Environment:\s*(.*?)\s*Image prompt:\s*(.*?)\s*Video prompt:\s*(.*?)(?=\n\s*Scene|\n*$)/gis;
            const scenes = [];
            let match;
            
            while ((match = sceneRegex.exec(scenesPart)) !== null) {
                scenes.push({
                    time: match[1].trim(),
                    environment: match[2].trim(),
                    imagePrompt: match[3].trim(),
                    videoPrompt: match[4].trim(),
                    narration: scriptPart
                });
            }

            if (scenes.length === 0) {
                const error = new Error('Tidak ada scene yang ditemukan');
                error.rawResponse = rawResponse;
                throw error;
            }

            return { script: scriptPart, scenes: scenes };
            
        } catch (error) {
            console.error('Error:', error);
            throw error;
        }
    }

    window.copyText = copyText;
    window.toggleFullPrompt = toggleFullPrompt;
</script>
</body>
</html>
